name: Build AgiAnalytics for All Windows Versions

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-all:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - os_label: "Win7"
            python_version: "3.7.9"
            architecture: "x86"
            exe_name: "AgiAnalytics_Win7_x86"
            upx: "--noupx"
            extra_args: "--disable-windowed-traceback"
          - os_label: "Win7"
            python_version: "3.7.9"
            architecture: "x64"
            exe_name: "AgiAnalytics_Win7_x64"
            upx: "--noupx"
            extra_args: "--disable-windowed-traceback"
          - os_label: "Win10"
            python_version: "3.8.10"
            architecture: "x86"
            exe_name: "AgiAnalytics_Win10_x86"
            upx: ""
            extra_args: ""
          - os_label: "Win10"
            python_version: "3.8.10"
            architecture: "x64"
            exe_name: "AgiAnalytics_Win10_x64"
            upx: ""
            extra_args: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python_version }} (${{ matrix.architecture }})
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python_version }}
          architecture: ${{ matrix.architecture }}

      - name: Install dependencies for ${{ matrix.os_label }}
        run: |
          python -m pip install --upgrade pip
          
          if "${{ matrix.os_label }}" == "Win7" {
            pip install numpy==1.21.6
            pip install pandas==1.3.5
            pip install PyQt5==5.15.4
            pip install pyinstaller==5.0.1
            pip install openpyxl==3.0.9
            pip install xlrd==2.0.1
            pip install pillow==8.4.0
          } else {
            pip install numpy==1.24.3
            pip install pandas==1.5.3
            pip install PyQt5==5.15.9
            pip install pyinstaller==5.12.0
            pip install openpyxl==3.1.2
            pip install pillow==9.5.0
          }
          
          echo "Dependencies installed for ${{ matrix.os_label }} ${{ matrix.architecture }}"

      - name: Build ${{ matrix.exe_name }}
        run: |
          # –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏
          Remove-Item -Recurse -Force dist, build -ErrorAction SilentlyContinue
          
          Write-Host "Building ${{ matrix.exe_name }}..."
          
          # –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã PyInstaller
          $pyinstallerArgs = @(
            "--onefile",
            "--windowed",
            "--name=${{ matrix.exe_name }}",
            "--clean",
            "--hidden-import=PyQt5",
            "--hidden-import=PyQt5.QtCore",
            "--hidden-import=PyQt5.QtGui",
            "--hidden-import=PyQt5.QtWidgets",
            "--hidden-import=pandas",
            "--hidden-import=numpy",
            "--hidden-import=numpy.core._multiarray_umath",
            "--hidden-import=openpyxl",
            "--hidden-import=sqlite3",
            "main.py"
          )
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
          if ("${{ matrix.upx }}" -ne "") {
            $pyinstallerArgs += "${{ matrix.upx }}"
          }
          
          if ("${{ matrix.extra_args }}" -ne "") {
            $pyinstallerArgs += "${{ matrix.extra_args }}"
          }
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
          if (Test-Path "icon.ico") {
            $pyinstallerArgs += "--icon=icon.ico"
          }
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–±–æ—Ä–∫—É
          Write-Host "Running: pyinstaller $pyinstallerArgs"
          pyinstaller @pyinstallerArgs
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          $exePath = "dist\${{ matrix.exe_name }}.exe"
          if (Test-Path $exePath) {
            $fileSize = (Get-Item $exePath).Length / 1MB
            Write-Host "‚úÖ Build successful! Size: $fileSize MB"
            
            # –î–ª—è Windows 7 —Å–æ–∑–¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π BAT —Ñ–∞–π–ª
            if ("${{ matrix.os_label }}" -eq "Win7") {
              $batContent = @"
              @echo off
              echo ========================================
              echo AgiAnalytics - Windows 7 Compatibility
              echo ========================================
              echo.
              echo –î–ª—è Windows 7 —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º:
              echo 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Visual C++ Redistributable
              echo 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ KB2999226
              echo 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Windows
              echo.
              echo –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã...
              start "" "%~dp0${{ matrix.exe_name }}.exe"
              pause
              "@
              Set-Content -Path "dist\Run_${{ matrix.exe_name }}.bat" -Value $batContent -Encoding ASCII
              Write-Host "Created compatibility launcher"
            }
          } else {
            Write-Error "‚ùå Build failed!"
            exit 1
          }

      - name: Upload ${{ matrix.exe_name }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.exe_name }}
          path: |
            dist/${{ matrix.exe_name }}.exe
            dist/Run_${{ matrix.exe_name }}.bat

  package-release:
    name: Create Release Package
    needs: [build-all]
    runs-on: windows-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create organized release structure
        run: |
          $version = "${{ github.run_number }}"
          $releaseDir = "AgiAnalytics_v$version"
          
          # –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –ø–∞–ø–∫—É
          New-Item -ItemType Directory -Force -Path $releaseDir
          
          # –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∞–ø–∫–∏
          $folders = @(
            "Windows_7_32bit",
            "Windows_7_64bit",
            "Windows_10_32bit",
            "Windows_10_64bit"
          )
          
          foreach ($folder in $folders) {
            New-Item -ItemType Directory -Force -Path "$releaseDir\$folder"
          }
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞–ø–∫–∏
          Write-Host "Copying files to release structure..."
          
          # Windows 7 32-bit
          if (Test-Path "artifacts/AgiAnalytics_Win7_x86/AgiAnalytics_Win7_x86.exe") {
            Copy-Item "artifacts/AgiAnalytics_Win7_x86/AgiAnalytics_Win7_x86.exe" "$releaseDir\Windows_7_32bit\"
            if (Test-Path "artifacts/AgiAnalytics_Win7_x86/Run_AgiAnalytics_Win7_x86.bat") {
              Copy-Item "artifacts/AgiAnalytics_Win7_x86/Run_AgiAnalytics_Win7_x86.bat" "$releaseDir\Windows_7_32bit\"
            }
            Write-Host "‚úì Windows 7 32-bit copied"
          }
          
          # Windows 7 64-bit
          if (Test-Path "artifacts/AgiAnalytics_Win7_x64/AgiAnalytics_Win7_x64.exe") {
            Copy-Item "artifacts/AgiAnalytics_Win7_x64/AgiAnalytics_Win7_x64.exe" "$releaseDir\Windows_7_64bit\"
            if (Test-Path "artifacts/AgiAnalytics_Win7_x64/Run_AgiAnalytics_Win7_x64.bat") {
              Copy-Item "artifacts/AgiAnalytics_Win7_x64/Run_AgiAnalytics_Win7_x64.bat" "$releaseDir\Windows_7_64bit\"
            }
            Write-Host "‚úì Windows 7 64-bit copied"
          }
          
          # Windows 10 32-bit
          if (Test-Path "artifacts/AgiAnalytics_Win10_x86/AgiAnalytics_Win10_x86.exe") {
            Copy-Item "artifacts/AgiAnalytics_Win10_x86/AgiAnalytics_Win10_x86.exe" "$releaseDir\Windows_10_32bit\"
            Write-Host "‚úì Windows 10 32-bit copied"
          }
          
          # Windows 10 64-bit
          if (Test-Path "artifacts/AgiAnalytics_Win10_x64/AgiAnalytics_Win10_x64.exe") {
            Copy-Item "artifacts/AgiAnalytics_Win10_x64/AgiAnalytics_Win10_x64.exe" "$releaseDir\Windows_10_64bit\"
            Write-Host "‚úì Windows 10 64-bit copied"
          }
          
          # –°–æ–∑–¥–∞–µ–º README —Ñ–∞–π–ª
          $readmeContent = @'
          ========================================
          AgiAnalytics - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤
          ========================================
          
          –í–µ—Ä—Å–∏—è: $version
          –î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏: $(Get-Date -Format "yyyy-MM-dd")
          
          üìÅ –°–û–î–ï–†–ñ–ê–ù–ò–ï –ê–†–•–ò–í–ê:
          
          1. Windows_7_32bit/    - –î–ª—è Windows 7 (32-bit)
          2. Windows_7_64bit/    - –î–ª—è Windows 7 (64-bit)
          3. Windows_10_32bit/   - –î–ª—è Windows 10 (32-bit)
          4. Windows_10_64bit/   - –î–ª—è Windows 10 (64-bit)
          
          üöÄ –ò–ù–°–¢–†–£–ö–¶–ò–Ø:
          
          –î–ª—è Windows 10:
          1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É Windows_10_32bit –∏–ª–∏ Windows_10_64bit
          2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª .exe
          
          –î–ª—è Windows 7:
          1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É Windows_7_32bit –∏–ª–∏ Windows_7_64bit
          2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª Run_*.bat (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
          3. –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª .exe –Ω–∞–ø—Ä—è–º—É—é
          
          ‚ö†Ô∏è –í–ê–ñ–ù–û –î–õ–Ø WINDOWS 7:
          
          –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:
          ‚Ä¢ Visual C++ Redistributable 2015-2022
          ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ KB2999226 (Universal C Runtime)
          ‚Ä¢ –í—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Windows
          
          üìû –ü–û–î–î–ï–†–ñ–ö–ê:
          
          GitHub Issues: https://github.com/${{ github.repository }}/issues
          '@
          
          Set-Content -Path "$releaseDir\README.txt" -Value $readmeContent -Encoding UTF8
          
          # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
          $installerScript = @'
          @echo off
          echo ========================================
          echo AgiAnalytics - –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          echo ========================================
          echo.
          echo –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É –≤–µ—Ä—Å–∏—é Windows:
          echo.
          echo 1. Windows 7 (32-bit)
          echo 2. Windows 7 (64-bit)
          echo 3. Windows 10 (32-bit)
          echo 4. Windows 10 (64-bit)
          echo.
          set /p choice="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä [1-4]: "
          
          if "%choice%"=="1" (
              echo –û—Ç–∫—Ä—ã–≤–∞—é –ø–∞–ø–∫—É –¥–ª—è Windows 7 32-bit...
              explorer "Windows_7_32bit"
          ) else if "%choice%"=="2" (
              echo –û—Ç–∫—Ä—ã–≤–∞—é –ø–∞–ø–∫—É –¥–ª—è Windows 7 64-bit...
              explorer "Windows_7_64bit"
          ) else if "%choice%"=="3" (
              echo –û—Ç–∫—Ä—ã–≤–∞—é –ø–∞–ø–∫—É –¥–ª—è Windows 10 32-bit...
              explorer "Windows_10_32bit"
          ) else if "%choice%"=="4" (
              echo –û—Ç–∫—Ä—ã–≤–∞—é –ø–∞–ø–∫—É –¥–ª—è Windows 10 64-bit...
              explorer "Windows_10_64bit"
          ) else (
              echo –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!
              pause
              exit /b 1
          )
          
          echo.
          echo –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤ —Ñ–∞–π–ª–µ README.txt
          pause
          '@
          
          Set-Content -Path "$releaseDir\Install.bat" -Value $installerScript -Encoding ASCII
          
          # –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º
          Write-Host "Creating ZIP archive..."
          Compress-Archive -Path "$releaseDir\*" -DestinationPath "AgiAnalytics_v$version.zip" -Force
          
          Write-Host "‚úÖ Release package created: AgiAnalytics_v$version.zip"
          Write-Host "Archive size: $((Get-Item "AgiAnalytics_v$version.zip").Length / 1MB) MB"

      - name: Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: AgiAnalytics-Release-Package
          path: AgiAnalytics_v${{ github.run_number }}.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: AgiAnalytics_v${{ github.run_number }}.zip
          tag_name: v${{ github.run_number }}
          name: AgiAnalytics v${{ github.run_number }}
          body: |
            # AgiAnalytics v${{ github.run_number }}
            
            –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ –¥–ª—è –≤—Å–µ—Ö –≤–µ—Ä—Å–∏–π Windows.
            
            ## üì¶ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞:
            
            | –í–µ—Ä—Å–∏—è Windows | –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | –§–∞–π–ª—ã |
            |----------------|-------------|-------|
            | Windows 7 | 32-bit | `AgiAnalytics_Win7_x86.exe` + `Run_AgiAnalytics_Win7_x86.bat` |
            | Windows 7 | 64-bit | `AgiAnalytics_Win7_x64.exe` + `Run_AgiAnalytics_Win7_x64.bat` |
            | Windows 10 | 32-bit | `AgiAnalytics_Win10_x86.exe` |
            | Windows 10 | 64-bit | `AgiAnalytics_Win10_x64.exe` |
            
            ## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:
            
            1. **–°–∫–∞—á–∞–π—Ç–µ** –∞—Ä—Ö–∏–≤
            2. **–†–∞—Å–ø–∞–∫—É–π—Ç–µ** –≤ –ª—é–±—É—é –ø–∞–ø–∫—É
            3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ** `Install.bat`
            4. **–í—ã–±–µ—Ä–∏—Ç–µ** –≤–∞—à—É –≤–µ—Ä—Å–∏—é Windows
            5. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ** –ø—Ä–æ–≥—Ä–∞–º–º—É
            
            ## ‚ö†Ô∏è –î–ª—è Windows 7:
            
            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `Run_*.bat` —Ñ–∞–π–ª—ã –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
            
            –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:
            - [Visual C++ Redistributable](https://aka.ms/vs/17/release/vc_redist.x86.exe)
            - [–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ KB2999226](https://support.microsoft.com/ru-ru/topic/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ-–¥–ª—è-—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π-—Å—Ä–µ–¥—ã-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è-c-–≤-windows-c0514201-7fe6-95a3-b0a5-287930f3560c)
            
            ## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
            
            | –ü–∞—Ä–∞–º–µ—Ç—Ä | Windows 7 | Windows 10 |
            |----------|-----------|------------|
            | Python | 3.7.9 | 3.8.10 |
            | PyInstaller | 5.0.1 | 5.12.0 |
            | UPX | –û—Ç–∫–ª—é—á–µ–Ω | –í–∫–ª—é—á–µ–Ω |
            
            ## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞:
            
            [–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ](https://github.com/${{ github.repository }}/issues)