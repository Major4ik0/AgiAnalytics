name: Build Windows Executable

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    strategy:
      matrix:
        python-version: ['3.8', '3.10']
        architecture: ['x86', 'x64']
        include:
          - python-version: '3.8'
            architecture: 'x86'
            windows-version: '7'
          - python-version: '3.8'
            architecture: 'x64'
            windows-version: '7'
          - python-version: '3.10'
            architecture: 'x86'
            windows-version: '10'
          - python-version: '3.10'
            architecture: 'x64'
            windows-version: '10'

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.architecture }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller==5.13.0

    - name: Build with PyInstaller
      run: |
        $pyinstaller_args = @(
          "--onefile",
          "--windowed",
          "--name=AgiAnalytics_Win${{ matrix.windows-version }}_${{ matrix.architecture }}",
          "--clean",
          "--noconfirm",
          "--distpath=dist",
          "--hidden-import=PyQt5",
          "--hidden-import=PyQt5.QtCore",
          "--hidden-import=PyQt5.QtGui",
          "--hidden-import=PyQt5.QtWidgets",
          "--hidden-import=pandas",
          "--hidden-import=numpy",
          "--hidden-import=openpyxl",
          "--hidden-import=sqlite3",
          "--hidden-import=pandas._libs.tslibs.timedeltas",
          "--hidden-import=pandas._libs.tslibs.nattype",
          "--hidden-import=pandas._libs.tslibs.base",
          "--hidden-import=pandas._libs.missing"
        )
        
        if ("${{ matrix.windows-version }}" -eq "7") {
          $pyinstaller_args += @("--noupx", "--disable-windowed-traceback")
        }
        
        if (Test-Path "icon.ico") {
          $pyinstaller_args += @("--icon=icon.ico")
        }
        
        $pyinstaller_args += @("main.py")
        
        Write-Host "Building with: $pyinstaller_args"
        pyinstaller @pyinstaller_args
        
        $exe_path = "dist/AgiAnalytics_Win${{ matrix.windows-version }}_${{ matrix.architecture }}.exe"
        if (Test-Path $exe_path) {
          $size = (Get-Item $exe_path).Length / 1MB
          Write-Host "âœ… Build successful! Size: $size MB"
        } else {
          Write-Error "âŒ Build failed"
          exit 1
        }

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: AgiAnalytics-Win${{ matrix.windows-version }}-${{ matrix.architecture }}
        path: dist/AgiAnalytics_Win${{ matrix.windows-version }}_${{ matrix.architecture }}.exe

  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
    - name: Download artifacts
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
        mkdir -p release_binaries
        
        # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð¿Ð¾ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸
        artifacts=(
          "AgiAnalytics-Win7-x86"
          "AgiAnalytics-Win7-x64"
          "AgiAnalytics-Win10-x86"
          "AgiAnalytics-Win10-x64"
        )
        
        for artifact in "${artifacts[@]}"; do
          echo "ðŸ“¥ Downloading $artifact..."
          gh run download ${{ github.run_id }} \
            --name "$artifact" \
            --dir "release_binaries" 2>/dev/null || echo "âš ï¸ Artifact $artifact not found"
        done
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÑÐºÐ°Ñ‡Ð°Ð»Ð¾ÑÑŒ
        echo "ðŸ“ Downloaded files:"
        find release_binaries -type f -name "*.exe" | while read file; do
          echo "  - $(basename "$file")"
        done

    - name: Create organized release structure
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°
        mkdir -p "AgiAnalytics_v${{ github.run_number }}"
        cd "AgiAnalytics_v${{ github.run_number }}"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÐ¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹
        mkdir -p "Windows_7/x86" "Windows_7/x64"
        mkdir -p "Windows_10/x86" "Windows_10/x64"
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ð°Ð¿ÐºÐ¸
        for file in ../release_binaries/*.exe; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "ðŸ“„ Processing $filename"
            
            # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÐºÑƒÐ´Ð° ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
            if [[ "$filename" == *"Win7_x86"* ]]; then
              cp "$file" "Windows_7/x86/"
            elif [[ "$filename" == *"Win7_x64"* ]]; then
              cp "$file" "Windows_7/x64/"
            elif [[ "$filename" == *"Win10_x86"* ]]; then
              cp "$file" "Windows_10/x86/"
            elif [[ "$filename" == *"Win10_x64"* ]]; then
              cp "$file" "Windows_10/x64/"
            fi
          fi
        done
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ README Ñ„Ð°Ð¹Ð»
        cat > "README.md" << 'EOF'
        # AgiAnalytics v${{ github.run_number }}
        
        ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð°Ð±Ð¸Ñ‚ÑƒÑ€Ð¸ÐµÐ½Ñ‚Ð¾Ð²
        
        ## Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸:
        
        ### Windows 7:
        - **32-bit (x86)**: Windows_7/x86/AgiAnalytics_Win7_x86.exe
        - **64-bit (x64)**: Windows_7/x64/AgiAnalytics_Win7_x64.exe
        
        ### Windows 10:
        - **32-bit (x86)**: Windows_10/x86/AgiAnalytics_Win10_x86.exe
        - **64-bit (x64)**: Windows_10/x64/AgiAnalytics_Win10_x64.exe
        
        ## Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ:
        
        1. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Windows Ð¸ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹
        2. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ .exe Ñ„Ð°Ð¹Ð» Ð² Ð»ÑŽÐ±Ð¾Ðµ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾
        3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð»
        
        ## Ð”Ð»Ñ Windows 7:
        
        ÐŸÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ:
        - Ð’ÑÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Windows Ñ‡ÐµÑ€ÐµÐ· Ð¦ÐµÐ½Ñ‚Ñ€ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
        - Visual C++ Redistributable Ð´Ð»Ñ Visual Studio 2015-2022
        - .NET Framework 4.5 Ð¸Ð»Ð¸ Ð½Ð¾Ð²ÐµÐµ
        
        ## Ð ÐµÑˆÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼:
        
        - Ð•ÑÐ»Ð¸ Ð°Ð½Ñ‚Ð¸Ð²Ð¸Ñ€ÑƒÑ Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÑ‚: Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ
        - Ð•ÑÐ»Ð¸ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ: Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°
        - Ð”Ð»Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ñ DLL: ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ KB2999226
        
        ---
        Ð¡Ð±Ð¾Ñ€ÐºÐ°: ${{ github.run_number }}
        Ð”Ð°Ñ‚Ð°: $(date +'%Y-%m-%d')
        EOF
        
        # Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ÑÑ Ð½Ð° ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð²Ñ‹ÑˆÐµ
        cd ..
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð²
        echo "ðŸ“¦ Creating archive..."
        zip -r "AgiAnalytics_v${{ github.run_number }}.zip" "AgiAnalytics_v${{ github.run_number }}"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð²
        echo "âœ… Archive created:"
        ls -la "AgiAnalytics_v${{ github.run_number }}.zip"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: AgiAnalytics_v${{ github.run_number }}.zip
        tag_name: v${{ github.run_number }}
        name: AgiAnalytics v${{ github.run_number }}
        body: |
          # ðŸš€ AgiAnalytics v${{ github.run_number }}
          
          **ÐŸÐ¾Ð»Ð½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ° Ð´Ð»Ñ Windows 7 Ð¸ Windows 10 (32-bit Ð¸ 64-bit)**
          
          ## ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð°:
          
          ```
          AgiAnalytics_v${{ github.run_number }}.zip/
          â”œâ”€â”€ README.md
          â”œâ”€â”€ Windows_7/
          â”‚   â”œâ”€â”€ x86/AgiAnalytics_Win7_x86.exe
          â”‚   â””â”€â”€ x64/AgiAnalytics_Win7_x64.exe
          â””â”€â”€ Windows_10/
              â”œâ”€â”€ x86/AgiAnalytics_Win10_x86.exe
              â””â”€â”€ x64/AgiAnalytics_Win10_x64.exe
          ```
          
          ## ðŸŽ¯ ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ:
          
          1. **Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ** Ð°Ñ€Ñ…Ð¸Ð²
          2. **Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ** ÐµÐ³Ð¾
          3. **ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ** Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Windows
          4. **Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ** `.exe` Ñ„Ð°Ð¹Ð»
          
          ## âš ï¸ Ð”Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Windows 7:
          
          ÐŸÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ ÑƒÐ±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹:
          - Ð’ÑÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Windows (Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ KB2999226)
          - Visual C++ Redistributable 2015-2022
          - .NET Framework 4.5+
          
          ## ðŸ”§ ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ¸:
          
          - **Windows 7:** Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½ UPX, Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ
          - **Windows 10:** Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ°
          - **Ð’ÑÐµ Ð²ÐµÑ€ÑÐ¸Ð¸:** ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
          
          | Ð’ÐµÑ€ÑÐ¸Ñ | Python | ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° |
          |--------|--------|-------------|
          | Windows 7 | 3.8 | x86, x64 |
          | Windows 10 | 3.10 | x86, x64 |
          
          ## ðŸ“Š Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ:
          
          - **ÐÐ¾Ð¼ÐµÑ€ ÑÐ±Ð¾Ñ€ÐºÐ¸:** ${{ github.run_number }}
          - **Ð”Ð°Ñ‚Ð°:** ${{ github.event.head_commit.timestamp }}
          - **ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          
          ## â“ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°:
          
          ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹: [Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Issue](https://github.com/${{ github.repository }}/issues)
        draft: false
        prerelease: false