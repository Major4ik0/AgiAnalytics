name: Build Windows Executable

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        include:
          - win: '7'
            python: '3.8'
            arch: 'x86'
          - win: '7'
            python: '3.8'
            arch: 'x64'
          - win: '10'
            python: '3.10'
            arch: 'x86'
          - win: '10'
            python: '3.10'
            arch: 'x64'

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python }}
        architecture: ${{ matrix.arch }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller==5.13.0

    - name: Build executable
      run: |
        $exe_name = "AgiAnalytics_Win${{ matrix.win }}_${{ matrix.arch }}"
        echo "Building $exe_name..."
        
        $args = @(
          "--onefile",
          "--windowed",
          "--name=$exe_name",
          "--clean",
          "--noconfirm",
          "--distpath=dist",
          "--hidden-import=PyQt5",
          "--hidden-import=PyQt5.QtCore",
          "--hidden-import=PyQt5.QtGui",
          "--hidden-import=PyQt5.QtWidgets",
          "--hidden-import=pandas",
          "--hidden-import=numpy",
          "--hidden-import=openpyxl",
          "--hidden-import=sqlite3",
          "main.py"
        )
        
        if ("${{ matrix.win }}" -eq "7") {
          $args += "--noupx"
          $args += "--disable-windowed-traceback"
        }
        
        if (Test-Path "icon.ico") {
          $args += "--icon=icon.ico"
        }
        
        Write-Host "Running: pyinstaller $args"
        pyinstaller @args
        
        $exe_path = "dist/$exe_name.exe"
        if (Test-Path $exe_path) {
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¼ Ð¸Ð¼ÐµÐ½ÐµÐ¼ Ð´Ð»Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°
          $artifact_name = "$exe_name.exe"
          Copy-Item $exe_path $artifact_name
          Write-Host "âœ… Build successful!"
        } else {
          Write-Error "âŒ Build failed"
          exit 1
        }

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: AgiAnalytics-Win${{ matrix.win }}-${{ matrix.arch }}
        path: AgiAnalytics_Win${{ matrix.win }}_${{ matrix.arch }}.exe

  package:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create organized release
      run: |
        echo "ðŸ“ Creating organized release structure..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ Ñ€ÐµÐ»Ð¸Ð·Ð°
        mkdir -p "AgiAnalytics_Release"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð´Ð¿Ð°Ð¿ÐºÐ¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹
        mkdir -p "AgiAnalytics_Release/Windows_7_32bit"
        mkdir -p "AgiAnalytics_Release/Windows_7_64bit"
        mkdir -p "AgiAnalytics_Release/Windows_10_32bit"
        mkdir -p "AgiAnalytics_Release/Windows_10_64bit"
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ð°Ð¿ÐºÐ¸
        for file in artifacts/*/*.exe; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "Processing: $filename"
            
            if [[ "$filename" == *"Win7_x86"* ]]; then
              cp "$file" "AgiAnalytics_Release/Windows_7_32bit/"
            elif [[ "$filename" == *"Win7_x64"* ]]; then
              cp "$file" "AgiAnalytics_Release/Windows_7_64bit/"
            elif [[ "$filename" == *"Win10_x86"* ]]; then
              cp "$file" "AgiAnalytics_Release/Windows_10_32bit/"
            elif [[ "$filename" == *"Win10_x64"* ]]; then
              cp "$file" "AgiAnalytics_Release/Windows_10_64bit/"
            fi
          fi
        done
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ README Ñ„Ð°Ð¹Ð»
        cat > "AgiAnalytics_Release/README.txt" << 'EOF'
        ========================================
        AgiAnalytics - ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð°Ð±Ð¸Ñ‚ÑƒÑ€Ð¸ÐµÐ½Ñ‚Ð¾Ð²
        ========================================
        
        Ð’ÐµÑ€ÑÐ¸Ñ: ${{ github.run_number }}
        Ð”Ð°Ñ‚Ð°: $(date +'%Y-%m-%d')
        
        ðŸ“ Ð¡ÐžÐ”Ð•Ð Ð–Ð˜ÐœÐžÐ• ÐÐ Ð¥Ð˜Ð’Ð:
        
        1. Windows_7_32bit/    - Ð”Ð»Ñ Windows 7 (32-bit)
        2. Windows_7_64bit/    - Ð”Ð»Ñ Windows 7 (64-bit)
        3. Windows_10_32bit/   - Ð”Ð»Ñ Windows 10 (32-bit)
        4. Windows_10_64bit/   - Ð”Ð»Ñ Windows 10 (64-bit)
        
        ðŸš€ Ð˜ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð˜Ð¯:
        
        1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Windows
        2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» AgiAnalytics_*.exe
        3. ÐŸÑ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ Ð°Ð½Ñ‚Ð¸Ð²Ð¸Ñ€ÑƒÑ Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ
        
        âš ï¸ Ð”Ð›Ð¯ WINDOWS 7:
        
        ÐŸÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ:
        â€¢ Visual C++ Redistributable 2015-2022
        â€¢ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ KB2999226 (Universal C Runtime)
        â€¢ Ð’ÑÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Windows Ñ‡ÐµÑ€ÐµÐ· Ð¦ÐµÐ½Ñ‚Ñ€ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
        
        ðŸ”§ Ð Ð•Ð¨Ð•ÐÐ˜Ð• ÐŸÐ ÐžÐ‘Ð›Ð•Ðœ:
        
        â€¢ ÐžÑˆÐ¸Ð±ÐºÐ° "api-ms-win-core-path-l1-1-0.dll" - ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ KB2999226
        â€¢ ÐÐ½Ñ‚Ð¸Ð²Ð¸Ñ€ÑƒÑ Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÑ‚ - Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ
        â€¢ ÐÐµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ - Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°
        
        ðŸ“ž ÐŸÐžÐ”Ð”Ð•Ð Ð–ÐšÐ:
        
        GitHub Issues: https://github.com/${{ github.repository }}/issues
        EOF
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ZIP Ð°Ñ€Ñ…Ð¸Ð²
        cd AgiAnalytics_Release
        zip -r "../AgiAnalytics_v${{ github.run_number }}.zip" .
        cd ..
        
        echo "âœ… Archive created: AgiAnalytics_v${{ github.run_number }}.zip"
        ls -la *.zip

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: AgiAnalytics_v${{ github.run_number }}.zip
        tag_name: v${{ github.run_number }}
        name: AgiAnalytics v${{ github.run_number }}
        body: |
          # ðŸš€ AgiAnalytics v${{ github.run_number }}
          
          **ÐŸÐ¾Ð»Ð½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ° Ð´Ð»Ñ Windows 7 Ð¸ 10 (32-bit Ð¸ 64-bit)**
          
          ## ðŸ“¦ Ð§Ñ‚Ð¾ Ð² Ð°Ñ€Ñ…Ð¸Ð²Ðµ:
          
          | Ð’ÐµÑ€ÑÐ¸Ñ Windows | ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° | ÐŸÑƒÑ‚ÑŒ Ð² Ð°Ñ€Ñ…Ð¸Ð²Ðµ |
          |----------------|-------------|---------------|
          | Windows 7 | 32-bit (x86) | `Windows_7_32bit/AgiAnalytics_Win7_x86.exe` |
          | Windows 7 | 64-bit (x64) | `Windows_7_64bit/AgiAnalytics_Win7_x64.exe` |
          | Windows 10 | 32-bit (x86) | `Windows_10_32bit/AgiAnalytics_Win10_x86.exe` |
          | Windows 10 | 64-bit (x64) | `Windows_10_64bit/AgiAnalytics_Win10_x64.exe` |
          
          ## âš¡ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚:
          
          1. **Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ** Ð°Ñ€Ñ…Ð¸Ð²
          2. **Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ** Ð² Ð»ÑŽÐ±ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ
          3. **ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ** Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Windows
          4. **Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ** `.exe` Ñ„Ð°Ð¹Ð»
          
          ## âš ï¸ Ð’Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ Windows 7:
          
          Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼:
          - [Visual C++ Redistributable](https://aka.ms/vs/17/release/vc_redist.x64.exe)
          - [ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ KB2999226](https://support.microsoft.com/ru-ru/topic/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ-Ð´Ð»Ñ-ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð¾Ð¹-ÑÑ€ÐµÐ´Ñ‹-Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ-c-Ð²-windows-c0514201-7fe6-95a3-b0a5-287930f3560c)
          - Ð’ÑÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Windows
          
          ## ðŸ› ï¸ Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸:
          
          | ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |
          |----------|----------|
          | Ð¡Ð±Ð¾Ñ€ÐºÐ° | #${{ github.run_number }} |
          | Python (Win7) | 3.8 |
          | Python (Win10) | 3.10 |
          | ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚ | [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |
          
          ## â“ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°:
          
          [Ð¡Ð¾Ð¾Ð±Ñ‰Ð¸Ñ‚ÑŒ Ð¾ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ðµ](https://github.com/${{ github.repository }}/issues)