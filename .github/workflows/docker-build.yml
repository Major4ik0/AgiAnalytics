name: Build Windows Executable

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'  # Используйте 3.10, 3.11 или 3.12
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller    
    # - name: Build with PyInstaller
    #   run: |
    #     # Проверяем наличие необходимых файлов
    #     if (!(Test-Path "main.py")) { throw "main.py not found!" }
    #     if (!(Test-Path "app.ui")) { Write-Host "Warning: app.ui not found" }
        
    #     # Собираем приложение
    #     pyinstaller `
    #       --onefile `
    #       --windowed `
    #       --name="AgiAnalytics" `
    #       --icon="icon.ico" `
    #       --add-data="app.ui;." `
    #       --hidden-import=PyQt6 `
    #       --hidden-import=PyQt6.QtCore `
    #       --hidden-import=PyQt6.QtGui `
    #       --hidden-import=PyQt6.QtWidgets `
    #       --hidden-import=pandas `
    #       --hidden-import=numpy `
    #       --hidden-import=openpyxl `
    #       --hidden-import=matplotlib `
    #       --clean `
    #       --noconfirm `
    #       main.py
        
    #     # Проверяем результат
    #     if (Test-Path "dist\AgiAnalytics.exe") {
    #       $size = (Get-Item "dist\AgiAnalytics.exe").Length
    #       Write-Host "✅ Build successful! File size: $size bytes"
    #     } else {
    #       Write-Error "❌ Build failed - executable not found"
    #       exit 1
    #     }

    - name: Install Nuitka
      run: pip install nuitka
    
    - name: Build with Nuitka
      run: |
        python -m nuitka `
          --onefile `
          --windows-console-mode=disable `
          --include-qt-plugins=sensible,styles `
          --plugin-enable=pyqt6 `
          --windows-icon-from-ico=icon.ico `
          --output-filename=AgiAnalytics.exe `
          main.py
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: AgiAnalytics-Windows
        path: dist/AgiAnalytics.exe
        retention-days: 7
