name: Build Windows Executable

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        include:
          - win: '7'
            python: '3.8'
            arch: 'x86'
          - win: '7'
            python: '3.8'
            arch: 'x64'
          - win: '10'
            python: '3.10'
            arch: 'x86'
          - win: '10'
            python: '3.10'
            arch: 'x64'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          architecture: ${{ matrix.arch }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller==5.13.0

      - name: Create PyQt5 hook
        run: |
          echo "from PyInstaller.utils.hooks import collect_submodules" > hook-PyQt5.py
          echo "hiddenimports = collect_submodules('PyQt5')" >> hook-PyQt5.py

      - name: Create pandas hook
        run: |
          echo "hiddenimports = [" > hook-pandas.py
          echo "    'pandas._libs.tslibs.np_datetime'," >> hook-pandas.py
          echo "    'pandas._libs.tslibs.timedeltas'," >> hook-pandas.py
          echo "    'pandas._libs.tslibs.nattype'," >> hook-pandas.py
          echo "    'pandas._libs.tslibs.base'," >> hook-pandas.py
          echo "    'pandas._libs.missing'," >> hook-pandas.py
          echo "]" >> hook-pandas.py

      - name: Build executable
        run: |
          $exe_name = "AgiAnalytics_Win${{ matrix.win }}_${{ matrix.arch }}"
          echo "Building $exe_name..."
          
          $args = @(
            "--onefile",
            "--windowed",
            "--name=$exe_name",
            "--clean",
            "--noconfirm",
            "--distpath=dist",
            "--additional-hooks-dir=."
          )
          
          if ("${{ matrix.win }}" -eq "7") {
            $args += "--noupx"
            $args += "--disable-windowed-traceback"
          }
          
          if (Test-Path "icon.ico") {
            $args += "--icon=icon.ico"
          }
          
          $hidden_imports = @(
            "PyQt5",
            "PyQt5.QtCore",
            "PyQt5.QtGui",
            "PyQt5.QtWidgets",
            "pandas",
            "numpy",
            "openpyxl",
            "sqlite3"
          )
          
          foreach ($import in $hidden_imports) {
            $args += "--hidden-import=$import"
          }
          
          $args += "main.py"
          
          Write-Host "Running: pyinstaller $args"
          pyinstaller @args
          
          $exe_path = "dist/$exe_name.exe"
          if (Test-Path $exe_path) {
            Copy-Item $exe_path .
            Write-Host "âœ… Build successful!"
          } else {
            Write-Error "âŒ Build failed"
            exit 1
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: $exe_name
          path: AgiAnalytics_Win${{ matrix.win }}_${{ matrix.arch }}.exe

  package:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release package
        run: |
          mkdir -p release
          find artifacts -name "*.exe" -exec cp {} release/ \;
          
          cat > release/README.txt << 'EOF'
          AgiAnalytics - Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð°Ð±Ð¸Ñ‚ÑƒÑ€Ð¸ÐµÐ½Ñ‚Ð¾Ð²
          
          Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸:
          1. Windows 7 32-bit: AgiAnalytics_Win7_x86.exe
          2. Windows 7 64-bit: AgiAnalytics_Win7_x64.exe
          3. Windows 10 32-bit: AgiAnalytics_Win10_x86.exe
          4. Windows 10 64-bit: AgiAnalytics_Win10_x64.exe
          
          Ð”Ð»Ñ Windows 7 ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ:
          - Visual C++ Redistributable 2015-2022
          - ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ KB2999226
          EOF
          
          cd release
          zip -r ../AgiAnalytics_Release.zip .
          cd ..
          echo "ðŸ“¦ Archive created"

      - name: Upload release
        uses: actions/upload-artifact@v4
        with:
          name: AgiAnalytics-Release
          path: AgiAnalytics_Release.zip