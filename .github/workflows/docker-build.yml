name: Build Windows Executable

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    strategy:
      matrix:
        python-version: ['3.8', '3.10']
        architecture: ['x86', 'x64']
        include:
          - python-version: '3.8'
            architecture: 'x86'
            windows-version: '7'
          - python-version: '3.8'
            architecture: 'x64'
            windows-version: '7'
          - python-version: '3.10'
            architecture: 'x86'
            windows-version: '10'
          - python-version: '3.10'
            architecture: 'x64'
            windows-version: '10'

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.architecture }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller==5.13.0

    - name: Build with PyInstaller
      run: |
        $pyinstaller_args = @(
          "--onefile",
          "--windowed",
          "--name=AgiAnalytics_Win${{ matrix.windows-version }}_${{ matrix.architecture }}",
          "--clean",
          "--noconfirm",
          "--distpath=dist",
          "--hidden-import=PyQt5",
          "--hidden-import=PyQt5.QtCore",
          "--hidden-import=PyQt5.QtGui",
          "--hidden-import=PyQt5.QtWidgets",
          "--hidden-import=pandas",
          "--hidden-import=numpy",
          "--hidden-import=openpyxl",
          "--hidden-import=sqlite3",
          "--hidden-import=pandas._libs.tslibs.timedeltas",
          "--hidden-import=pandas._libs.tslibs.nattype",
          "--hidden-import=pandas._libs.tslibs.base",
          "--hidden-import=pandas._libs.missing"
        )
        
        if ("${{ matrix.windows-version }}" -eq "7") {
          $pyinstaller_args += @("--noupx", "--disable-windowed-traceback")
        }
        
        if (Test-Path "icon.ico") {
          $pyinstaller_args += @("--icon=icon.ico")
        }
        
        $pyinstaller_args += @("main.py")
        
        Write-Host "Building with: $pyinstaller_args"
        pyinstaller @pyinstaller_args
        
        $exe_path = "dist/AgiAnalytics_Win${{ matrix.windows-version }}_${{ matrix.architecture }}.exe"
        if (Test-Path $exe_path) {
          Write-Host "✅ Build successful!"
        } else {
          Write-Error "❌ Build failed"
          exit 1
        }

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: AgiAnalytics-Win${{ matrix.windows-version }}-${{ matrix.architecture }}
        path: dist/AgiAnalytics_Win${{ matrix.windows-version }}_${{ matrix.architecture }}.exe

  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
    - name: Download artifacts
      run: |
        mkdir -p artifacts
        for version in 7 10; do
          for arch in x86 x64; do
            echo "Downloading Windows $version $arch..."
            gh run download ${{ github.run_id }} \
              -n "AgiAnalytics-Win$version-$arch" \
              -D "artifacts" 2>/dev/null || true
          done
        done

    - name: Create zip
      run: |
        mkdir -p release
        cp artifacts/*.exe release/ 2>/dev/null || true
        cd release
        zip -r ../AgiAnalytics_Release.zip *
        cd ..

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: AgiAnalytics_Release.zip
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        body: |
          # AgiAnalytics v${{ github.run_number }}
          
          Windows 7 и 10 (32-bit и 64-bit)
          
          Сборка #${{ github.run_number }}