name: Build Windows Executable

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  build-win7-x64:
    name: Build Universal x64 (Win7/10/11)
    runs-on: windows-2019

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.8.10 (x64)
        uses: actions/setup-python@v5
        with:
          python-version: '3.8.10'
          architecture: x64

      - name: Install dependencies for x64
        run: |
          python -m pip install --upgrade pip
          pip install numpy==1.21.6 pandas==1.3.5 PyQt5==5.15.4 pyinstaller==5.13.0 openpyxl==3.0.10 pillow==9.5.0 msoffcrypto-tool==4.12.0 olefile==0.46 xlrd==2.0.1 xlwt==1.3.0

      - name: Create spec file for better resource handling
        run: |
          # –°–æ–∑–¥–∞–µ–º spec —Ñ–∞–π–ª –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ —Ä–µ—Å—É—Ä—Å–∞–º–∏
          $spec_content = @'
          # -*- mode: python ; coding: utf-8 -*-
          import sys
          import os
          from PyInstaller.utils.hooks import collect_data_files, collect_submodules
          
          # –†–µ—à–µ–Ω–∏–µ –¥–ª—è –∏–∫–æ–Ω–æ–∫ –∏ —Ä–µ—Å—É—Ä—Å–æ–≤
          def get_resource_path(relative_path):
              """–ü–æ–ª—É—á–∏—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ —Ä–µ—Å—É—Ä—Å—É."""
              try:
                  # PyInstaller —Å–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –≤ _MEIPASS
                  base_path = sys._MEIPASS
              except Exception:
                  # –ü—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
                  base_path = os.path.abspath(".")
              
              return os.path.join(base_path, relative_path)
          
          a = Analysis(
              ['main.py'],
              pathex=[],
              binaries=[],
              datas=[
                  ('icons', 'icons'),  # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å—é –ø–∞–ø–∫—É icons
                  ('icons/icon.ico', '.'),  # –ò–∫–æ–Ω–∫—É –≤ –∫–æ—Ä–µ–Ω—å
              ],
              hiddenimports=[
                  'PyQt5',
                  'PyQt5.QtCore',
                  'PyQt5.QtGui',
                  'PyQt5.QtWidgets',
                  'pandas',
                  'numpy',
                  'numpy.core._multiarray_umath',
                  'openpyxl',
                  'openpyxl.cell._writer',
                  'openpyxl.utils',
                  'sqlite3',
                  'PIL',
                  'PIL._imaging',
                  'PIL.Image',
                  'xlrd',
                  'xlrd.compdoc',
                  'xlrd.xlsx',
                  'xlwt',
                  'xlwt.ExcelFormula',
                  'xlwt.ExcelFormulaParser',
                  'msoffcrypto',
                  'olefile',
                  'encodings.utf_8',
                  'encodings.cp1251',
                  'sip',
              ],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=None,
              noarchive=False,
          )
          
          # –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
          pyz = PYZ(a.pure)
          
          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.datas,
              [],
              name='AgiAnalytics_x64',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=False,  # –û—Ç–∫–ª—é—á–∞–µ–º UPX –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
              upx_exclude=[],
              runtime_tmpdir=None,
              console=False,  # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–Ω—Å–æ–ª—å
              disable_windowed_traceback=False,
              argv_emulation=False,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
              icon=['icons/icon.ico'],  # –ü—É—Ç—å –∫ –∏–∫–æ–Ω–∫–µ
          )
          '@
          
          Set-Content -Path "main.spec" -Value $spec_content -Encoding UTF8
          Write-Host "‚úÖ Spec —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω"

      - name: Build x64 executable using spec file
        run: |
          $exe_name = "AgiAnalytics_x64"
          Remove-Item -Recurse -Force dist, build -ErrorAction SilentlyContinue
          
          # –°—Ç—Ä–æ–∏–º —Å –ø–æ–º–æ—â—å—é spec —Ñ–∞–π–ª–∞
          pyinstaller --clean --noconfirm main.spec
          
          if (Test-Path "dist/$exe_name.exe") {
            Write-Host "‚úÖ –°–±–æ—Ä–∫–∞ x64 —É—Å–ø–µ—à–Ω–∞"
            $size = (Get-Item "dist/$exe_name.exe").Length / 1MB
            Write-Host "üì¶ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $($size.ToString('0.00')) MB"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ—Å—É—Ä—Å—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã
            Write-Host "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤:"
            Get-ChildItem -Path "dist" -Recurse | ForEach-Object {
              Write-Host "   $($_.FullName)"
            }
          } else {
            Write-Error "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ x64"
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏ –æ—à–∏–±–æ–∫
            if (Test-Path "build") {
              Get-ChildItem -Path "build" -Recurse -Filter "*.log" | ForEach-Object {
                Write-Host "üìÑ –õ–æ–≥ —Ñ–∞–π–ª: $($_.FullName)"
                Get-Content $_.FullName -Tail 100
              }
            }
            exit 1
          }

      - name: Create test script to verify resources
        run: |
          # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏
          $test_script = @'
          import sys
          import os
          import traceback
          
          def get_resource_path(relative_path):
              """–ü–æ–ª—É—á–∏—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ —Ä–µ—Å—É—Ä—Å—É."""
              try:
                  # PyInstaller —Å–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –≤ _MEIPASS
                  base_path = sys._MEIPASS
                  print(f"–†–µ–∂–∏–º PyInstaller, –±–∞–∑–æ–≤–∞—è –ø–∞–ø–∫–∞: {base_path}")
              except Exception:
                  # –ü—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
                  base_path = os.path.abspath(".")
                  print(f"–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –±–∞–∑–æ–≤–∞—è –ø–∞–ø–∫–∞: {base_path}")
              
              resource_path = os.path.join(base_path, relative_path)
              print(f"–ò—â–µ–º —Ä–µ—Å—É—Ä—Å: {relative_path}")
              print(f"–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: {resource_path}")
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
              if os.path.exists(resource_path):
                  print(f"‚úÖ –†–µ—Å—É—Ä—Å –Ω–∞–π–¥–µ–Ω: {resource_path}")
                  return resource_path
              else:
                  print(f"‚ùå –†–µ—Å—É—Ä—Å –ù–ï –Ω–∞–π–¥–µ–Ω: {resource_path}")
                  # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≤ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
                  possible_paths = [
                      resource_path,
                      os.path.join(os.path.dirname(sys.executable), relative_path),
                      os.path.join(os.path.dirname(__file__), relative_path),
                  ]
                  
                  for path in possible_paths:
                      if os.path.exists(path):
                          print(f"‚úÖ –ù–∞–π–¥–µ–Ω –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ: {path}")
                          return path
                  
                  return None
          
          # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ —Ä–µ—Å—É—Ä—Å–æ–≤
          print("=" * 50)
          print("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å–∞–º")
          print("=" * 50)
          
          # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–∫–æ–Ω–∫—É
          icon_path = get_resource_path("icon.ico")
          if icon_path:
              print(f"–ò–∫–æ–Ω–∫–∞: {icon_path}")
          else:
              print("–ò–∫–æ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
          
          # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–∞–ø–∫—É icons
          icons_dir = get_resource_path("icons")
          if icons_dir and os.path.isdir(icons_dir):
              print(f"–ü–∞–ø–∫–∞ icons: {icons_dir}")
              print("–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ icons:")
              for item in os.listdir(icons_dir):
                  print(f"  - {item}")
          else:
              print("–ü–∞–ø–∫–∞ icons –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
          
          print("=" * 50)
          '@
          
          Set-Content -Path "test_resources.py" -Value $test_script -Encoding UTF8
          Write-Host "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω"

      - name: Test the executable
        run: |
          # –¢–µ—Å—Ç–∏—Ä—É–µ–º exe —Ñ–∞–π–ª
          if (Test-Path "dist/AgiAnalytics_x64.exe") {
            Write-Host "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –≤–æ–æ–±—â–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
            $test_result = Start-Process -FilePath "dist/AgiAnalytics_x64.exe" -ArgumentList "--test" -NoNewWindow -Wait -PassThru
            Write-Host "–ö–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $($test_result.ExitCode)"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É dist
            Write-Host "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ dist:"
            Get-ChildItem -Path "dist" -Recurse | ForEach-Object {
              $size_kb = [math]::Round($_.Length / 1KB, 2)
              Write-Host "  $($_.FullName) ($size_kb KB)"
            }
          }

      - name: Upload x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgiAnalytics-x64
          path: |
            dist/AgiAnalytics_x64.exe
            test_resources.py

  build-win7-x86:
    name: Build Legacy x86 (Win7/10/11)
    runs-on: windows-2019

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.8.10 (x86)
        uses: actions/setup-python@v5
        with:
          python-version: '3.8.10'
          architecture: x86

      - name: Install dependencies for x86
        run: |
          python -m pip install --upgrade pip==20.3.4
          pip install wheel==0.34.2 setuptools==44.0.0 numpy==1.19.3 pandas==1.3.5 PyQt5==5.15.4 pyinstaller==5.0.1 openpyxl==3.0.9 xlrd==2.0.1 xlwt==1.3.0 pillow==8.4.0 msoffcrypto-tool==4.12.0 olefile==0.46

      - name: Create spec file for x86
        run: |
          # –°–æ–∑–¥–∞–µ–º spec —Ñ–∞–π–ª –¥–ª—è x86
          $spec_content = @'
          # -*- mode: python ; coding: utf-8 -*-
          import sys
          import os
          
          a = Analysis(
              ['main.py'],
              pathex=[],
              binaries=[],
              datas=[
                  ('icons', 'icons'),
                  ('icons/icon.ico', '.'),
              ],
              hiddenimports=[
                  'PyQt5',
                  'PyQt5.QtCore',
                  'PyQt5.QtGui',
                  'PyQt5.QtWidgets',
                  'pandas',
                  'numpy',
                  'numpy.core._multiarray_umath',
                  'openpyxl',
                  'openpyxl.cell._writer',
                  'openpyxl.utils',
                  'sqlite3',
                  'PIL',
                  'PIL._imaging',
                  'PIL.Image',
                  'xlrd',
                  'xlrd.compdoc',
                  'xlrd.xlsx',
                  'xlwt',
                  'xlwt.ExcelFormula',
                  'xlwt.ExcelFormulaParser',
                  'msoffcrypto',
                  'olefile',
                  'encodings.utf_8',
                  'encodings.cp1251',
                  'sip',
              ],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=None,
              noarchive=False,
          )
          
          pyz = PYZ(a.pure)
          
          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.datas,
              [],
              name='AgiAnalytics_x86',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=False,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=False,
              disable_windowed_traceback=False,
              argv_emulation=False,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
              icon=['icons/icon.ico'],
          )
          '@
          
          Set-Content -Path "main_x86.spec" -Value $spec_content -Encoding UTF8
          Write-Host "‚úÖ Spec —Ñ–∞–π–ª –¥–ª—è x86 —Å–æ–∑–¥–∞–Ω"

      - name: Build x86 executable
        run: |
          $exe_name = "AgiAnalytics_x86"
          Remove-Item -Recurse -Force dist, build -ErrorAction SilentlyContinue
          
          pyinstaller --clean --noconfirm main_x86.spec
          
          if (Test-Path "dist/$exe_name.exe") {
            Write-Host "‚úÖ –°–±–æ—Ä–∫–∞ x86 —É—Å–ø–µ—à–Ω–∞"
            $size = (Get-Item "dist/$exe_name.exe").Length / 1MB
            Write-Host "üì¶ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $($size.ToString('0.00')) MB"
          } else {
            Write-Error "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ x86"
            exit 1
          }

      - name: Upload x86 artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgiAnalytics-x86
          path: dist/AgiAnalytics_x86.exe

  create-release:
    name: Create Universal Release
    needs: [build-win7-x64, build-win7-x86]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: AgiAnalytics-*
          merge-multiple: true

      - name: Create release structure
        run: |
          version=${{ github.run_number }}
          release_name="AgiAnalytics_v$version"
          
          # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–æ–≤
          mkdir -p "$release_name"
          mkdir -p "$release_name/x64"
          mkdir -p "$release_name/x86"
          mkdir -p "$release_name/icons"  # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–ø–∫—É –¥–ª—è –∏–∫–æ–Ω–æ–∫
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã
          if [ -f "artifacts/AgiAnalytics_x64.exe" ]; then
            cp "artifacts/AgiAnalytics_x64.exe" "$release_name/x64/"
            echo "‚úÖ x64 –≤–µ—Ä—Å–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞"
          elif [ -f "artifacts/AgiAnalytics-x64/AgiAnalytics_x64.exe" ]; then
            cp "artifacts/AgiAnalytics-x64/AgiAnalytics_x64.exe" "$release_name/x64/"
            echo "‚úÖ x64 –≤–µ—Ä—Å–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ (–∏–∑ –ø–æ–¥–ø–∞–ø–∫–∏)"
          fi
          
          if [ -f "artifacts/AgiAnalytics_x86.exe" ]; then
            cp "artifacts/AgiAnalytics_x86.exe" "$release_name/x86/"
            echo "‚úÖ x86 –≤–µ—Ä—Å–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞"
          elif [ -f "artifacts/AgiAnalytics-x86/AgiAnalytics_x86.exe" ]; then
            cp "artifacts/AgiAnalytics-x86/AgiAnalytics_x86.exe" "$release_name/x86/"
            echo "‚úÖ x86 –≤–µ—Ä—Å–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ (–∏–∑ –ø–æ–¥–ø–∞–ø–∫–∏)"
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∏–∫–æ–Ω–∫–∏ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          if [ -d "icons" ]; then
            cp -r icons/* "$release_name/icons/"
            echo "‚úÖ –ò–∫–æ–Ω–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
          fi
          
          # –°–æ–∑–¥–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ª–∞—É–Ω—á–µ—Ä —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø—É—Ç–µ–π
          cat > "$release_name/Start_AgiAnalytics.bat" << 'EOF'
          @echo off
          chcp 65001 >nul
          setlocal enabledelayedexpansion
          
          echo ========================================
          echo   AgiAnalytics - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫
          echo ========================================
          echo.
          
          REM –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å–∏—Å—Ç–µ–º—ã
          if "%PROCESSOR_ARCHITECTURE%"=="AMD64" (
              set ARCH=x64
              set EXE_NAME=AgiAnalytics_x64.exe
          ) else (
              set ARCH=x86
              set EXE_NAME=AgiAnalytics_x86.exe
          )
          
          REM –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Å–∏—é Windows
          ver | find "10." > nul
          if %errorlevel% equ 0 set WIN_VER=10
          
          ver | find "6.1" > nul
          if %errorlevel% equ 0 set WIN_VER=7
          
          echo –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: Windows %WIN_VER% (%ARCH%)
          echo.
          
          REM –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
          if exist "%ARCH%\!EXE_NAME!" (
              echo –ó–∞–ø—É—Å–∫: !EXE_NAME!
              echo.
              
              REM –î–ª—è Windows 7 –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
              if "%WIN_VER%"=="7" (
                  echo ‚ö†Ô∏è  –í–ê–ñ–ù–û –î–õ–Ø WINDOWS 7:
                  echo 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Windows
                  echo 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ KB2999226
                  echo 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Visual C++ Redistributable
                  echo.
                  echo –ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è...
                  pause > nul
              )
              
              REM –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É
              start "" "%ARCH%\!EXE_NAME!"
          ) else (
              echo ‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª !EXE_NAME! –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–ø–∫–µ %ARCH%
              echo.
              echo –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ %ARCH%:
              if exist "%ARCH%" (
                  dir /b "%ARCH%\"
              )
              echo.
              pause
          )
          
          endlocal
          EOF
                    
                    # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Windows 7
                    cat > "$release_name/Install_Win7_Requirements.bat" << 'EOF'
          @echo off
          chcp 65001 >nul
          echo ========================================
          echo   –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –¥–ª—è Windows 7
          echo ========================================
          echo.
          echo –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
          echo –¥–ª—è —Ä–∞–±–æ—Ç—ã AgiAnalytics –Ω–∞ Windows 7.
          echo.
          echo 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ KB2999226 (Universal C Runtime)
          echo 2. Visual C++ Redistributable
          echo.
          echo –ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è –Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏...
          pause > nul
          echo.
          
          echo üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ KB2999226...
          powershell -Command "Start-BitsTransfer -Source 'https://download.microsoft.com/download/D/1/3/D13F2F5C-0241-42D5-A4D7-4F8E8C21B5F9/Windows6.1-KB2999226-x64.msu' -Destination 'KB2999226.msu'"
          if exist "KB2999226.msu" (
              echo –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º KB2999226...
              wusa.exe KB2999226.msu /quiet /norestart
              echo ‚úÖ KB2999226 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
          ) else (
              echo ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å KB2999226
              echo –°–∫–∞—á–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é —Å —Å–∞–π—Ç–∞ Microsoft
          )
          
          echo.
          echo üì• –ó–∞–≥—Ä—É–∂–∞–µ–º Visual C++ Redistributable...
          powershell -Command "Start-BitsTransfer -Source 'https://aka.ms/vs/17/release/vc_redist.x64.exe' -Destination 'vc_redist.x64.exe'"
          if exist "vc_redist.x64.exe" (
              echo –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º VC++ Redistributable...
              vc_redist.x64.exe /install /quiet /norestart
              echo ‚úÖ VC++ Redistributable —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
          ) else (
              echo ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å VC++ Redistributable
          )
          
          echo.
          echo ========================================
          echo –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
          echo –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ Start_AgiAnalytics.bat
          echo ========================================
          pause
          EOF
                    
                    # –°–æ–∑–¥–∞–µ–º README —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
                    cat > "$release_name/README.txt" << EOF
          ========================================
          AgiAnalytics v$version
          ========================================
          
          üìÅ –°–¢–†–£–ö–¢–£–†–ê –ê–†–•–ò–í–ê:
          /x64/AgiAnalytics_x64.exe     - 64-–±–∏—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è
          /x86/AgiAnalytics_x86.exe     - 32-–±–∏—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è
          /icons/                       - –§–∞–π–ª—ã –∏–∫–æ–Ω–æ–∫
          Start_AgiAnalytics.bat        - –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
          Install_Win7_Requirements.bat - –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è Win7
          
          üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢:
          1. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤
          2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Start_AgiAnalytics.bat
          3. –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Å–∞–º–∞ –≤—ã–±–µ—Ä–µ—Ç –Ω—É–∂–Ω—É—é –≤–µ—Ä—Å–∏—é
          
          üîß –†–£–ß–ù–û–ô –ó–ê–ü–£–°–ö:
          ‚Ä¢ 64-–±–∏—Ç–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã: –∑–∞–ø—É—Å—Ç–∏—Ç–µ x64/AgiAnalytics_x64.exe
          ‚Ä¢ 32-–±–∏—Ç–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã: –∑–∞–ø—É—Å—Ç–∏—Ç–µ x86/AgiAnalytics_x86.exe
          
          ‚ö†Ô∏è  –î–õ–Ø WINDOWS 7:
          –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ Windows 7:
          1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Install_Win7_Requirements.bat
          2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Windows —á–µ—Ä–µ–∑ –¶–µ–Ω—Ç—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä
          
          üõ†Ô∏è  –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú:
          
          1. –û—à–∏–±–∫–∞ "api-ms-win-core-*.dll"
             –†–µ—à–µ–Ω–∏–µ: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ KB2999226
          
          2. –û—à–∏–±–∫–∞ "VCRUNTIME140.dll"
             –†–µ—à–µ–Ω–∏–µ: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Visual C++ Redistributable
          
          3. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Å—Ä–∞–∑—É –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
             –†–µ—à–µ–Ω–∏–µ: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—à–∏–±–æ–∫
          
          4. –ù–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∫–æ–Ω–∫–∏
             –†–µ—à–µ–Ω–∏–µ: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–ø–∫–∞ "icons" –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä—è–¥–æ–º —Å exe-—Ñ–∞–π–ª–æ–º
          
          üìû –ü–û–î–î–ï–†–ñ–ö–ê:
          GitHub: https://github.com/${{ github.repository }}/issues
          EOF

      - name: Create ZIP archive
        run: |
          version=${{ github.run_number }}
          release_name="AgiAnalytics_v$version"
          zip -r "${release_name}.zip" "$release_name"
          echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: ${release_name}.zip"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–º–µ—Ä–µ
          echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–ª–∏–∑–µ:"
          du -sh "$release_name"
          du -sh "${release_name}.zip"
          echo "–§–∞–π–ª—ã –≤ —Ä–µ–ª–∏–∑–µ:"
          find "$release_name" -type f | sort

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgiAnalytics-Release
          path: AgiAnalytics_v${{ github.run_number }}.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: AgiAnalytics_v${{ github.run_number }}.zip
          tag_name: v${{ github.run_number }}
          name: AgiAnalytics v${{ github.run_number }}
          body: |
            ## üöÄ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –¥–ª—è Windows 7-11
            
            ### üì¶ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–ª–∏–∑–∞:
            - **x64/AgiAnalytics_x64.exe** - 64-–±–∏—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è
            - **x86/AgiAnalytics_x86.exe** - 32-–±–∏—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è  
            - **Start_AgiAnalytics.bat** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫–∞—Ç–æ—Ä
            - **Install_Win7_Requirements.bat** - –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è Windows 7
            - **README.txt** - –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
            
            ### ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:
            1. –°–∫–∞—á–∞–π—Ç–µ –∏ —Ä–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤
            2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `Start_AgiAnalytics.bat`
            3. –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Å–∞–º–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≤–∞—à—É —Å–∏—Å—Ç–µ–º—É
            
            ### üõ†Ô∏è –î–ª—è Windows 7 (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):
            –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:
            ```bash
            # 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            –ó–∞–ø—É—Å—Ç–∏—Ç–µ Install_Win7_Requirements.bat
            
            # 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Windows
            –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -> –¶–µ–Ω—Ç—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            
            # 3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä
            ```
            
            ### üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:
            ```bash
            # –í –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ:
            echo %PROCESSOR_ARCHITECTURE%
            
            # –ï—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç AMD64 - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ x64 –≤–µ—Ä—Å–∏—é
            # –ï—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç x86 - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ x86 –≤–µ—Ä—Å–∏—é
            ```
            
            ### üìä –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
            | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ú–∏–Ω–∏–º—É–º | –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
            |-----------|---------|---------------|
            | –û–ó–£ | 2 –ì–ë | 8 –ì–ë |
            | –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä | 2 —è–¥—Ä–∞ | 4+ —è–¥–µ—Ä |
            | –ú–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ | 100 –ú–ë | 1 –ì–ë |
            | –û–° | Windows 7 SP1 | Windows 10+ |
            
            ### üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è:
            
            **–ü—Ä–æ–±–ª–µ–º–∞ 1:** –û—à–∏–±–∫–∏ —Å api-ms-win-core-*.dll
            **–†–µ—à–µ–Ω–∏–µ:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ [KB2999226](https://support.microsoft.com/en-us/topic/update-for-universal-c-runtime-in-windows-c0514201-7fe6-95a3-b0a5-287930f3560c)
            
            **–ü—Ä–æ–±–ª–µ–º–∞ 2:** –û—à–∏–±–∫–∞ VCRUNTIME140.dll
            **–†–µ—à–µ–Ω–∏–µ:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ [Visual C++ Redistributable](https://aka.ms/vs/17/release/vc_redist.x64.exe)
            
            **–ü—Ä–æ–±–ª–µ–º–∞ 3:** –ü—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ –≤–∏–¥–∏—Ç –∏–∫–æ–Ω–∫–∏
            **–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å–∫–∞–π—Ç–µ —á–µ—Ä–µ–∑ Start_AgiAnalytics.bat –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–∞–ø–∫—É icons —Ä—è–¥–æ–º —Å exe-—Ñ–∞–π–ª–æ–º
            
            ### üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
            - **–í–µ—Ä—Å–∏—è Python:** 3.8.10
            - **–§–æ—Ä–º–∞—Ç:** Portable (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
            - **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** x86 –∏ x64
            - **–¢–∏–ø:** –û–∫–æ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (GUI)
            
            ### üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
            - [–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥](https://github.com/${{ github.repository }})
            - [–ë–∞–≥—Ä–µ–ø–æ—Ä—Ç—ã](https://github.com/${{ github.repository }}/issues)
            - [–ß–µ–π–Ω–¥–∂–ª–æ–≥](https://github.com/${{ github.repository }}/releases)
            
            ---
            *–°–±–æ—Ä–∫–∞ ‚Ññ${{ github.run_number }} –æ—Ç $(date -u +'%Y-%m-%d %H:%M UTC')*
          draft: false
          prerelease: false