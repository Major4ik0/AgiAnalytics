name: Build AgiAnalytics for All Windows Versions

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-all:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - os_label: "Win7"
            python_version: "3.7.9"
            architecture: "x86"
            exe_name: "AgiAnalytics_Win7_x86"
            upx: "--noupx"
            extra_args: "--disable-windowed-traceback"
          - os_label: "Win7"
            python_version: "3.7.9"
            architecture: "x64"
            exe_name: "AgiAnalytics_Win7_x64"
            upx: "--noupx"
            extra_args: "--disable-windowed-traceback"
          - os_label: "Win10"
            python_version: "3.8.10"
            architecture: "x86"
            exe_name: "AgiAnalytics_Win10_x86"
            upx: ""
            extra_args: ""
          - os_label: "Win10"
            python_version: "3.8.10"
            architecture: "x64"
            exe_name: "AgiAnalytics_Win10_x64"
            upx: ""
            extra_args: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python_version }} (${{ matrix.architecture }})
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python_version }}
          architecture: ${{ matrix.architecture }}

      - name: Install dependencies for ${{ matrix.os_label }}
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          
          # Используем переменные окружения для определения версии
          $os_label = "${{ matrix.os_label }}"
          
          if ($os_label -eq "Win7") {
            pip install numpy==1.21.6
            pip install pandas==1.3.5
            pip install PyQt5==5.15.4
            pip install pyinstaller==5.0.1
            pip install openpyxl==3.0.9
            pip install xlrd==2.0.1
            pip install pillow==8.4.0
          } else {
            pip install numpy==1.24.3
            pip install pandas==1.5.3
            pip install PyQt5==5.15.9
            pip install pyinstaller==5.12.0
            pip install openpyxl==3.1.2
            pip install pillow==9.5.0
          }
          
          Write-Host "Dependencies installed for $os_label ${{ matrix.architecture }}"

      - name: Build ${{ matrix.exe_name }}
        shell: pwsh
        run: |
          # Очищаем предыдущие сборки
          Remove-Item -Recurse -Force dist, build -ErrorAction SilentlyContinue
          
          $exe_name = "${{ matrix.exe_name }}"
          Write-Host "Building $exe_name..."
          
          # Базовые параметры PyInstaller
          $pyinstallerArgs = @(
            "--onefile",
            "--windowed",
            "--name=$exe_name",
            "--clean",
            "--hidden-import=PyQt5",
            "--hidden-import=PyQt5.QtCore",
            "--hidden-import=PyQt5.QtGui",
            "--hidden-import=PyQt5.QtWidgets",
            "--hidden-import=pandas",
            "--hidden-import=numpy",
            "--hidden-import=numpy.core._multiarray_umath",
            "--hidden-import=openpyxl",
            "--hidden-import=sqlite3",
            "main.py"
          )
          
          # Добавляем специфичные параметры
          $upx = "${{ matrix.upx }}"
          $extra_args = "${{ matrix.extra_args }}"
          
          if ($upx -ne "") {
            $pyinstallerArgs += $upx
          }
          
          if ($extra_args -ne "") {
            $pyinstallerArgs += $extra_args
          }
          
          # Добавляем иконку если есть
          if (Test-Path "icon.ico") {
            $pyinstallerArgs += "--icon=icon.ico"
          }
          
          # Выполняем сборку
          Write-Host "Running: pyinstaller $pyinstallerArgs"
          pyinstaller @pyinstallerArgs
          
          # Проверяем результат
          $exePath = "dist\$exe_name.exe"
          if (Test-Path $exePath) {
            $fileSize = (Get-Item $exePath).Length / 1MB
            Write-Host "Build successful! Size: $fileSize MB"
            
            # Для Windows 7 создаем дополнительный BAT файл
            $os_label = "${{ matrix.os_label }}"
            if ($os_label -eq "Win7") {
              $batContent = @"
              @echo off
              echo ========================================
              echo AgiAnalytics - Windows 7 Compatibility
              echo ========================================
              echo.
              echo Для Windows 7 рекомендуем:
              echo 1. Установить Visual C++ Redistributable
              echo 2. Установить обновление KB2999226
              echo 3. Установить все обновления Windows
              echo.
              echo Запуск программы...
              start "" "%~dp0$exe_name.exe"
              pause
              "@
              Set-Content -Path "dist\Run_$exe_name.bat" -Value $batContent -Encoding ASCII
              Write-Host "Created compatibility launcher"
            }
          } else {
            Write-Error "Build failed!"
            exit 1
          }

      - name: Upload ${{ matrix.exe_name }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.exe_name }}
          path: |
            dist/${{ matrix.exe_name }}.exe
            dist/Run_${{ matrix.exe_name }}.bat

  package-release:
    name: Create Release Package
    needs: [build-all]
    runs-on: windows-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create organized release structure
        shell: pwsh
        run: |
          $version = "${{ github.run_number }}"
          $releaseDir = "AgiAnalytics_v$version"
          
          # Создаем основную папку
          New-Item -ItemType Directory -Force -Path $releaseDir
          
          # Создаем подпапки
          $folders = @(
            "Windows_7_32bit",
            "Windows_7_64bit",
            "Windows_10_32bit",
            "Windows_10_64bit"
          )
          
          foreach ($folder in $folders) {
            New-Item -ItemType Directory -Force -Path "$releaseDir\$folder"
          }
          
          # Копируем файлы в соответствующие папки
          Write-Host "Copying files to release structure..."
          
          # Windows 7 32-bit
          if (Test-Path "artifacts/AgiAnalytics_Win7_x86/AgiAnalytics_Win7_x86.exe") {
            Copy-Item "artifacts/AgiAnalytics_Win7_x86/AgiAnalytics_Win7_x86.exe" "$releaseDir\Windows_7_32bit\"
            if (Test-Path "artifacts/AgiAnalytics_Win7_x86/Run_AgiAnalytics_Win7_x86.bat") {
              Copy-Item "artifacts/AgiAnalytics_Win7_x86/Run_AgiAnalytics_Win7_x86.bat" "$releaseDir\Windows_7_32bit\"
            }
            Write-Host "Windows 7 32-bit copied"
          }
          
          # Windows 7 64-bit
          if (Test-Path "artifacts/AgiAnalytics_Win7_x64/AgiAnalytics_Win7_x64.exe") {
            Copy-Item "artifacts/AgiAnalytics_Win7_x64/AgiAnalytics_Win7_x64.exe" "$releaseDir\Windows_7_64bit\"
            if (Test-Path "artifacts/AgiAnalytics_Win7_x64/Run_AgiAnalytics_Win7_x64.bat") {
              Copy-Item "artifacts/AgiAnalytics_Win7_x64/Run_AgiAnalytics_Win7_x64.bat" "$releaseDir\Windows_7_64bit\"
            }
            Write-Host "Windows 7 64-bit copied"
          }
          
          # Windows 10 32-bit
          if (Test-Path "artifacts/AgiAnalytics_Win10_x86/AgiAnalytics_Win10_x86.exe") {
            Copy-Item "artifacts/AgiAnalytics_Win10_x86/AgiAnalytics_Win10_x86.exe" "$releaseDir\Windows_10_32bit\"
            Write-Host "Windows 10 32-bit copied"
          }
          
          # Windows 10 64-bit
          if (Test-Path "artifacts/AgiAnalytics_Win10_x64/AgiAnalytics_Win10_x64.exe") {
            Copy-Item "artifacts/AgiAnalytics_Win10_x64/AgiAnalytics_Win10_x64.exe" "$releaseDir\Windows_10_64bit\"
            Write-Host "Windows 10 64-bit copied"
          }
          
          # Создаем README файл
          $readmeContent = @"
          ========================================
          AgiAnalytics - Приложение для абитуриентов
          ========================================
          
          Версия: $version
          Дата сборки: $(Get-Date -Format "yyyy-MM-dd")
          
          СОДЕРЖАНИЕ АРХИВА:
          
          1. Windows_7_32bit/    - Для Windows 7 (32-bit)
          2. Windows_7_64bit/    - Для Windows 7 (64-bit)
          3. Windows_10_32bit/   - Для Windows 10 (32-bit)
          4. Windows_10_64bit/   - Для Windows 10 (64-bit)
          
          ИНСТРУКЦИЯ:
          
          Для Windows 10:
          1. Откройте папку Windows_10_32bit или Windows_10_64bit
          2. Запустите файл .exe
          
          Для Windows 7:
          1. Откройте папку Windows_7_32bit или Windows_7_64bit
          2. Запустите файл Run_*.bat (рекомендуется)
          3. Или запустите файл .exe напрямую
          
          ВАЖНО ДЛЯ WINDOWS 7:
          
          Перед запуском установите:
          • Visual C++ Redistributable 2015-2022
          • Обновление KB2999226 (Universal C Runtime)
          • Все обновления Windows
          
          ПОДДЕРЖКА:
          
          GitHub Issues: https://github.com/${{ github.repository }}/issues
          "@
          
          Set-Content -Path "$releaseDir\README.txt" -Value $readmeContent -Encoding UTF8
          
          # Создаем простой установочный скрипт
          $installerScript = @'
          @echo off
          echo ========================================
          echo AgiAnalytics - Установка
          echo ========================================
          echo.
          echo Выберите вашу версию Windows:
          echo.
          echo 1. Windows 7 (32-bit)
          echo 2. Windows 7 (64-bit)
          echo 3. Windows 10 (32-bit)
          echo 4. Windows 10 (64-bit)
          echo.
          set /p choice="Введите номер [1-4]: "
          
          if "%choice%"=="1" (
              echo Открываю папку для Windows 7 32-bit...
              explorer "Windows_7_32bit"
          ) else if "%choice%"=="2" (
              echo Открываю папку для Windows 7 64-bit...
              explorer "Windows_7_64bit"
          ) else if "%choice%"=="3" (
              echo Открываю папку для Windows 10 32-bit...
              explorer "Windows_10_32bit"
          ) else if "%choice%"=="4" (
              echo Открываю папку для Windows 10 64-bit...
              explorer "Windows_10_64bit"
          ) else (
              echo Неверный выбор!
              pause
              exit /b 1
          )
          
          echo.
          echo Подробная инструкция в файле README.txt
          pause
          '@
          
          Set-Content -Path "$releaseDir\Install.bat" -Value $installerScript -Encoding ASCII
          
          # Архивируем
          Write-Host "Creating ZIP archive..."
          Compress-Archive -Path "$releaseDir\*" -DestinationPath "AgiAnalytics_v$version.zip" -Force
          
          Write-Host "Release package created: AgiAnalytics_v$version.zip"
          Write-Host "Archive size: $((Get-Item "AgiAnalytics_v$version.zip").Length / 1MB) MB"

      - name: Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: AgiAnalytics-Release-Package
          path: AgiAnalytics_v${{ github.run_number }}.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: AgiAnalytics_v${{ github.run_number }}.zip
          tag_name: v${{ github.run_number }}
          name: AgiAnalytics v${{ github.run_number }}
          body: |
            # AgiAnalytics v${{ github.run_number }}
            
            Полная сборка для всех версий Windows.
            
            ## Содержимое архива:
            
            | Версия Windows | Архитектура | Файлы |
            |----------------|-------------|-------|
            | Windows 7 | 32-bit | AgiAnalytics_Win7_x86.exe + Run_AgiAnalytics_Win7_x86.bat |
            | Windows 7 | 64-bit | AgiAnalytics_Win7_x64.exe + Run_AgiAnalytics_Win7_x64.bat |
            | Windows 10 | 32-bit | AgiAnalytics_Win10_x86.exe |
            | Windows 10 | 64-bit | AgiAnalytics_Win10_x64.exe |
            
            ## Быстрый старт:
            
            1. Скачайте архив
            2. Распакуйте в любую папку
            3. Запустите Install.bat
            4. Выберите вашу версию Windows
            5. Запустите программу
            
            ## Для Windows 7:
            
            Используйте Run_*.bat файлы для лучшей совместимости.
            
            Перед запуском установите:
            - Visual C++ Redistributable
            - Обновление KB2999226
            
            ## Технические детали:
            
            | Параметр | Windows 7 | Windows 10 |
            |----------|-----------|------------|
            | Python | 3.7.9 | 3.8.10 |
            | PyInstaller | 5.0.1 | 5.12.0 |
            | UPX | Отключен | Включен |
            
            ## Поддержка:
            
            Сообщить о проблеме