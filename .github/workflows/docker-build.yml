name: Build Windows Executable

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYINSTALLER_VERSION: "5.13.0"
  DEVELOPER: "Алексей Журавлев"

jobs:
  build-windows:
    strategy:
      matrix:
        config:
          - python-version: '3.8'
            architecture: 'x86'
            windows-version: '7'
          - python-version: '3.8'
            architecture: 'x64'
            windows-version: '7'
          - python-version: '3.10'
            architecture: 'x86'
            windows-version: '10'
          - python-version: '3.10'
            architecture: 'x64'
            windows-version: '10'

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.config.python-version }}
        architecture: ${{ matrix.config.architecture }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install PyQt5==5.15.10
        pip install PyQt5-sip==12.13.0
        pip install pandas==1.5.3
        pip install openpyxl==3.1.2
        pip install pyinstaller==${{ env.PYINSTALLER_VERSION }}
        pip install pywin32==306
        pip install numpy==1.24.3
        
        if ("${{ matrix.config.windows-version }}" -eq "7") {
          pip install "numpy<1.24" --force-reinstall
          pip install "pandas<2.0" --force-reinstall
        }

    - name: Create runtime hook
      run: |
        $runtime_hook = @'
import os
import sys
import ctypes
from pathlib import Path

def fix_windows_dll_issues():
    if sys.platform != 'win32':
        return

    try:
        import platform
        win_info = platform.win32_ver()

        if win_info[0] == '7':
            print("Windows 7 обнаружена")

            if hasattr(sys, '_MEIPASS'):
                base_path = Path(sys._MEIPASS)
                dll_paths = [
                    base_path / 'dll_includes',
                    base_path,
                    base_path.parent / 'dll_includes'
                ]

                for dll_path in dll_paths:
                    if dll_path.exists():
                        dll_path_str = str(dll_path)
                        if dll_path_str not in os.environ['PATH']:
                            os.environ['PATH'] = dll_path_str + ';' + os.environ['PATH']

                critical_dlls = [
                    'api-ms-win-core-path-l1-1-0.dll',
                    'vcruntime140.dll',
                    'vcruntime140_1.dll',
                    'msvcp140.dll',
                    'msvcp140_1.dll',
                    'msvcp140_2.dll',
                    'concrt140.dll'
                ]

                for dll_name in critical_dlls:
                    try:
                        for dll_path in dll_paths:
                            dll_file = dll_path / dll_name
                            if dll_file.exists():
                                ctypes.CDLL(str(dll_file))
                                break
                    except Exception:
                        pass

        if hasattr(sys, '_MEIPASS'):
            sys.path.insert(0, sys._MEIPASS)

    except Exception as e:
        print(f"Ошибка в runtime hook: {e}")

if __name__ == '__main__':
    fix_windows_dll_issues()
'@
        $runtime_hook | Out-File -FilePath "runtime_hook.py" -Encoding UTF8

    - name: Download VC Redist for Windows 7
      if: matrix.config.windows-version == '7'
      run: |
        if ("${{ matrix.config.architecture }}" -eq "x86") {
            $vc_arch = "x86"
        } else {
            $vc_arch = "x64"
        }
        $vc_redist_url = "https://aka.ms/vs/17/release/vc_redist.$vc_arch.exe"
        Invoke-WebRequest -Uri $vc_redist_url -OutFile "vc_redist_$vc_arch.exe"

    - name: Collect required DLLs for Windows 7
      if: matrix.config.windows-version == '7'
      run: |
        New-Item -ItemType Directory -Force -Path "dll_includes"
        
        $critical_dlls = @(
          "api-ms-win-core-path-l1-1-0.dll",
          "vcruntime140.dll",
          "vcruntime140_1.dll",
          "msvcp140.dll",
          "msvcp140_1.dll",
          "msvcp140_2.dll",
          "concrt140.dll",
          "vcomp140.dll"
        )
        
        $system_paths = @(
          "C:\Windows\System32",
          "C:\Windows\SysWOW64"
        )
        
        foreach ($dll in $critical_dlls) {
          foreach ($path in $system_paths) {
            $full_path = Join-Path $path $dll
            if (Test-Path $full_path) {
              Copy-Item -Path $full_path -Destination "dll_includes\$dll" -Force
              break
            }
          }
        }
        
        $install_bat = @'
@echo off
echo Установка DLL для Windows 7
echo.
setlocal enabledelayedexpansion
if "%PROCESSOR_ARCHITECTURE%"=="AMD64" (
    set "SYS_PATH=%SystemRoot%\SysWOW64"
) else (
    set "SYS_PATH=%SystemRoot%\System32"
)
for %%f in (*.dll) do (
    echo Копирование %%f...
    copy "%%f" "%SYS_PATH%\" >nul 2>&1
)
echo.
echo Готово
pause
'@
        $install_bat | Out-File -FilePath "dll_includes\install_dlls.bat" -Encoding ASCII
        
        $readme_content = '# DLL для Windows 7'
        $readme_content | Out-File -FilePath "dll_includes\README_DLL.txt" -Encoding UTF8

    - name: Test PyQt5
      run: |
        python -c "import PyQt5; from PyQt5 import QtCore, QtGui, QtWidgets; print('PyQt5 OK')"

    - name: Build executable
      run: |
        $exe_name = "AgiAnalytics_Win${{ matrix.config.windows-version }}_${{ matrix.config.architecture }}"
        $pyinstaller_args = @(
          "--onefile",
          "--windowed",
          "--name=$exe_name",
          "--clean",
          "--noconfirm",
          "--distpath=dist",
          "--workpath=build",
          "--noupx",
          "--win-private-assemblies",
          "--win-no-prefer-redirects",
          "--hidden-import=PyQt5",
          "--hidden-import=PyQt5.QtCore",
          "--hidden-import=PyQt5.QtGui",
          "--hidden-import=PyQt5.QtWidgets",
          "--hidden-import=pandas",
          "--hidden-import=numpy",
          "--hidden-import=openpyxl",
          "--hidden-import=sqlite3",
          "--add-data=database.py;.",
          "--add-data=statistics_widget.py;."
        )
        
        if ("${{ matrix.config.windows-version }}" -eq "7") {
          $pyinstaller_args += "--disable-windowed-traceback"
          $pyinstaller_args += "--runtime-hook=runtime_hook.py"
          if (Test-Path "dll_includes") {
            $pyinstaller_args += "--add-data=dll_includes;dll_includes"
          }
        }
        
        if (Test-Path "icon.ico") {
          $pyinstaller_args += "--icon=icon.ico"
        }
        
        $pyinstaller_args += "main.py"
        
        pyinstaller @pyinstaller_args
        
        $exe_path = "dist\$exe_name.exe"
        if (Test-Path $exe_path) {
          $size = (Get-Item $exe_path).Length
          $size_mb = [math]::Round($size / 1MB, 2)
          Write-Host "Сборка успешна: $exe_path ($size_mb MB)"
        } else {
          Write-Error "Сборка не удалась"
          exit 1
        }

    - name: Create package
      run: |
        $win_version = "${{ matrix.config.windows-version }}"
        $arch = "${{ matrix.config.architecture }}"
        $exe_name = "AgiAnalytics_Win${win_version}_${arch}"
        $package_name = "${exe_name}_Package"
        
        New-Item -ItemType Directory -Force -Path $package_name
        Copy-Item -Path "dist\${exe_name}.exe" -Destination "${package_name}\${exe_name}.exe"
        
        if ($win_version -eq "7") {
          if (Test-Path "dll_includes") {
            Copy-Item -Path "dll_includes" -Destination "${package_name}\" -Recurse
          }
          
          if ($arch -eq "x86") {
            $vc_file = "vc_redist_x86.exe"
          } else {
            $vc_file = "vc_redist_x64.exe"
          }
          
          if (Test-Path $vc_file) {
            Copy-Item -Path $vc_file -Destination "${package_name}\vc_redist.exe"
          }
        }
        
        $readme_content = @"
# AgiAnalytics для Windows $win_version ($arch)

Разработчик: ${{ env.DEVELOPER }}
Версия: ${{ github.run_number }}
Дата: $(Get-Date -Format 'yyyy-MM-dd')

## Установка:
1. Запустите ${exe_name}.exe
2. Для Windows 7: установите DLL через install_dlls.bat

## Требования:
- Windows $win_version SP1 или новее
- .NET Framework 4.5+
- 2 ГБ ОЗУ
"@
        $readme_content | Out-File -FilePath "${package_name}\README.txt" -Encoding UTF8
        
        $zip_name = "${package_name}.zip"
        Compress-Archive -Path "${package_name}\*" -DestinationPath $zip_name -Force
        
        Copy-Item -Path "dist\${exe_name}.exe" -Destination "${exe_name}.exe"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: AgiAnalytics-Win${{ matrix.config.windows-version }}-${{ matrix.config.architecture }}
        path: |
          $exe_name.exe
          $zip_name

    - name: Cleanup
      run: |
        Remove-Item -Path "build", "__pycache__", "dist", "*.spec" -Recurse -Force -ErrorAction SilentlyContinue

  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write

    steps:
    - name: Download artifacts
      run: |
        mkdir -p release_files
        for version in 7 10; do
          for arch in x86 x64; do
            gh run download ${{ github.run_id }} -n "AgiAnalytics-Win${version}-${arch}" -D "release_files/Windows${version}" 2>/dev/null || true
          done
        done

    - name: Create release files
      run: |
        cd release_files
        cat > README.md << 'EOF'
# AgiAnalytics
Разработчик: Алексей Журавлев
Версия: ${{ github.run_number }}

## Windows 7
- AgiAnalytics_Win7_x86.exe
- AgiAnalytics_Win7_x64.exe

## Windows 10
- AgiAnalytics_Win10_x86.exe
- AgiAnalytics_Win10_x64.exe
EOF
        
        if [ -d "Windows7" ] || [ -d "Windows10" ]; then
          tar -czf ../AgiAnalytics_Windows_All.tar.gz Windows*/ README.md
        fi
        
        for version in 7 10; do
          if [ -d "Windows${version}" ]; then
            tar -czf ../AgiAnalytics_Windows_${version}.tar.gz "Windows${version}/" README.md
          fi
        done
    
    - name: Create release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: |
          AgiAnalytics_Windows_All.tar.gz
          AgiAnalytics_Windows_7.tar.gz
          AgiAnalytics_Windows_10.tar.gz
        tag_name: v${{ github.run_number }}
        name: AgiAnalytics v${{ github.run_number }}
        body: |
          # AgiAnalytics v${{ github.run_number }}
          
          Разработчик: Алексей Журавлев
          
          ## Windows версии:
          - Windows 7 (x86/x64)
          - Windows 10 (x86/x64)
          
          ## Архивы:
          1. AgiAnalytics_Windows_All.tar.gz - все версии
          2. AgiAnalytics_Windows_7.tar.gz - только Windows 7
          3. AgiAnalytics_Windows_10.tar.gz - только Windows 10
          
          GitHub: ${{ github.repository }}
          Коммит: ${{ github.sha }}
        draft: false
        prerelease: false