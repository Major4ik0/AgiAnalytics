name: Build Windows Executable

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    strategy:
      matrix:
        python-version: ['3.8', '3.10']
        architecture: ['x86', 'x64']
        include:
          - python-version: '3.8'
            architecture: 'x86'
            windows-version: '7'
          - python-version: '3.8'
            architecture: 'x64'
            windows-version: '7'
          - python-version: '3.10'
            architecture: 'x86'
            windows-version: '10'
          - python-version: '3.10'
            architecture: 'x64'
            windows-version: '10'

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python ${{ matrix.python-version }} (${{ matrix.architecture }})
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.architecture }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller==5.13.0

    - name: Check Python architecture
      run: |
        python -c "import platform; print(f'Python version: {platform.python_version()}'); print(f'Architecture: {platform.architecture()[0]}')"

    - name: Build executable
      run: |
        # –î–ª—è Windows 7 –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏
        $pyinstaller_args = @(
          "--onefile",
          "--windowed",
          "--name=AgiAnalytics_Win${{ matrix.windows-version }}_${{ matrix.architecture }}",
          "--clean",
          "--noconfirm",
          "--distpath=dist_${{ matrix.windows-version }}_${{ matrix.architecture }}",
          "--hidden-import=PyQt5",
          "--hidden-import=PyQt5.QtCore",
          "--hidden-import=PyQt5.QtGui",
          "--hidden-import=PyQt5.QtWidgets",
          "--hidden-import=pandas",
          "--hidden-import=numpy",
          "--hidden-import=openpyxl",
          "--hidden-import=sqlite3"
        )
        
        # –î–ª—è Windows 7 –æ—Ç–∫–ª—é—á–∞–µ–º UPX –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏
        if ("${{ matrix.windows-version }}" -eq "7") {
          $pyinstaller_args += @("--noupx", "--disable-windowed-traceback")
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
        if (Test-Path "icon.ico") {
          $pyinstaller_args += @("--icon=icon.ico")
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª
        $pyinstaller_args += @("main.py")
        
        Write-Host "–°–±–æ—Ä–∫–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: $pyinstaller_args"
        pyinstaller @pyinstaller_args
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        $exe_path = "dist_${{ matrix.windows-version }}_${{ matrix.architecture }}/AgiAnalytics_Win${{ matrix.windows-version }}_${{ matrix.architecture }}.exe"
        if (Test-Path $exe_path) {
          $size = (Get-Item $exe_path).Length
          Write-Host "‚úÖ Build successful! File: $exe_path"
          Write-Host "üìè File size: $size bytes"
        } else {
          Write-Error "‚ùå Build failed - executable not found"
          exit 1
        }

    - name: Create artifacts directory
      run: |
        New-Item -ItemType Directory -Force -Path "artifacts"

    - name: Copy artifacts
      run: |
        $source = "dist_${{ matrix.windows-version }}_${{ matrix.architecture }}/AgiAnalytics_Win${{ matrix.windows-version }}_${{ matrix.architecture }}.exe"
        $destination = "artifacts/AgiAnalytics_Win${{ matrix.windows-version }}_${{ matrix.architecture }}.exe"
        Copy-Item -Path $source -Destination $destination -Force

    - name: Upload all artifacts
      if: matrix.architecture == 'x64' && matrix.windows-version == '10'
      uses: actions/upload-artifact@v4
      with:
        name: AgiAnalytics-Windows-All
        path: artifacts/*
        retention-days: 30

  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        name: AgiAnalytics-Windows-All
        path: release_artifacts

    - name: Create release archive
      run: |
        cd release_artifacts
        tar -czvf ../AgiAnalytics_Windows_All.zip *
        cd ..
        echo "Archive created: AgiAnalytics_Windows_All.zip"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: AgiAnalytics_Windows_All.zip
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        body: |
          # AgiAnalytics Windows Builds
          
          –°–æ–¥–µ—Ä–∂–∏—Ç –≤–µ—Ä—Å–∏–∏ –¥–ª—è:
          - Windows 7 (32-bit –∏ 64-bit)
          - Windows 10 (32-bit –∏ 64-bit)
          
          ## –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
          - Windows 7 SP1 –∏–ª–∏ –Ω–æ–≤–µ–µ
          - .NET Framework 4.5 (–¥–ª—è Windows 7)
          - 2 –ì–ë –û–ó–£
          - 100 –ú–ë —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ