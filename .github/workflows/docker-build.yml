name: Build Windows Executable

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-win7-x86:
    name: Build Windows 7 (x86)
    runs-on: windows-2019

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.8.10 (x86)
        uses: actions/setup-python@v5
        with:
          python-version: '3.8.10'
          architecture: x86

      - name: Install dependencies for Windows 7 (x86)
        run: |
          python -m pip install --upgrade pip==20.3.4
          pip install wheel==0.34.2
          pip install setuptools==44.0.0
          pip install numpy==1.19.3
          pip install pandas==1.3.5
          pip install PyQt5==5.15.4
          pip install pyinstaller==5.0.1
          pip install openpyxl==3.0.9
          pip install xlrd==2.0.1
          pip install pillow==8.4.0

      - name: Create custom spec file for Windows 7 x86
        run: |
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ spec —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –µ—Å—Ç—å
          Remove-Item -Force win7_spec.spec -ErrorAction SilentlyContinue
          
          # –°–æ–∑–¥–∞–µ–º spec —Ñ–∞–π–ª —á–µ—Ä–µ–∑ pyinstaller
          pyinstaller --onefile --windowed --name="AgiAnalytics_Win7_x86" --noupx --disable-windowed-traceback --clean --noconfirm main.py --specpath .
          
          # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π spec —Ñ–∞–π–ª
          $specFile = "AgiAnalytics_Win7_x86.spec"
          if (Test-Path $specFile) {
            $content = Get-Content $specFile -Raw
            $content = $content -replace "upx=True", "upx=False"
            $content = $content -replace "console=False", "console=False`n    disable_windowed_traceback=True"
            
            # –î–æ–±–∞–≤–ª—è–µ–º hidden imports
            if ($content -match "hiddenimports=\[") {
              $content = $content -replace "hiddenimports=\[", @'
              hiddenimports=[
                  'PyQt5', 'PyQt5.QtCore', 'PyQt5.QtGui', 'PyQt5.QtWidgets',
                  'pandas', 'numpy', 'numpy.core._multiarray_umath',
                  'openpyxl', 'openpyxl.cell._writer', 'openpyxl.utils',
                  'sqlite3', 'PIL', 'PIL._imaging', 'PIL.Image',
                  'xlrd', 'xlrd.compdoc', 'xlrd.xlsx'
              '@
            }
            
            Set-Content -Path $specFile -Value $content -Encoding UTF8
            Write-Host "‚úÖ Spec —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω: $specFile"
          }

      - name: Build executable for Windows 7 (x86) using spec
        run: |
          $exe_name = "AgiAnalytics_Win7_x86"
          Remove-Item -Recurse -Force dist, build -ErrorAction SilentlyContinue
          
          # –°—Ç—Ä–æ–∏–º –∏—Å–ø–æ–ª—å–∑—É—è spec —Ñ–∞–π–ª –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
          pyinstaller AgiAnalytics_Win7_x86.spec
          
          if (Test-Path "dist/$exe_name.exe") {
            Write-Host "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞ –¥–ª—è Windows 7 x86"
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
            $size = (Get-Item "dist/$exe_name.exe").Length / 1MB
            Write-Host "üì¶ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $($size.ToString('0.00')) MB"
          } else {
            Write-Error "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –¥–ª—è Windows 7 x86"
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (Test-Path "build") {
              Get-ChildItem -Path "build" -Recurse -Filter "*.log" | ForEach-Object {
                Write-Host "üìÑ –õ–æ–≥ —Ñ–∞–π–ª: $($_.FullName)"
                Get-Content $_.FullName -Tail 50
              }
            }
            exit 1
          }

      - name: Upload Windows 7 x86 artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgiAnalytics-Win7-x86
          path: dist/AgiAnalytics_Win7_x86.exe

  build-win7-x64:
    name: Build Windows 7 (x64)
    runs-on: windows-2019

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.8.10 (x64)
        uses: actions/setup-python@v5
        with:
          python-version: '3.8.10'
          architecture: x64

      - name: Install dependencies for Windows 7 (x64)
        run: |
          python -m pip install --upgrade pip==20.3.4
          pip install wheel==0.34.2
          pip install setuptools==44.0.0
          pip install numpy==1.19.3
          pip install pandas==1.3.5
          pip install PyQt5==5.15.4
          pip install pyinstaller==5.0.1
          pip install openpyxl==3.0.9
          pip install xlrd==2.0.1
          pip install pillow==8.4.0

      - name: Create custom spec file for Windows 7 x64
        run: |
          Remove-Item -Force AgiAnalytics_Win7_x64.spec -ErrorAction SilentlyContinue
          
          pyinstaller --onefile --windowed --name="AgiAnalytics_Win7_x64" --noupx --disable-windowed-traceback --clean --noconfirm main.py --specpath .
          
          $specFile = "AgiAnalytics_Win7_x64.spec"
          if (Test-Path $specFile) {
            $content = Get-Content $specFile -Raw
            $content = $content -replace "upx=True", "upx=False"
            $content = $content -replace "console=False", "console=False`n    disable_windowed_traceback=True"
            
            if ($content -match "hiddenimports=\[") {
              $content = $content -replace "hiddenimports=\[", @'
              hiddenimports=[
                  'PyQt5', 'PyQt5.QtCore', 'PyQt5.QtGui', 'PyQt5.QtWidgets',
                  'pandas', 'numpy', 'numpy.core._multiarray_umath',
                  'openpyxl', 'openpyxl.cell._writer', 'openpyxl.utils',
                  'sqlite3', 'PIL', 'PIL._imaging', 'PIL.Image',
                  'xlrd', 'xlrd.compdoc', 'xlrd.xlsx'
              '@
            }
            
            Set-Content -Path $specFile -Value $content -Encoding UTF8
            Write-Host "‚úÖ Spec —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω: $specFile"
          }

      - name: Build executable for Windows 7 (x64) using spec
        run: |
          $exe_name = "AgiAnalytics_Win7_x64"
          Remove-Item -Recurse -Force dist, build -ErrorAction SilentlyContinue
          
          pyinstaller AgiAnalytics_Win7_x64.spec
          
          if (Test-Path "dist/$exe_name.exe") {
            Write-Host "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞ –¥–ª—è Windows 7 x64"
            $size = (Get-Item "dist/$exe_name.exe").Length / 1MB
            Write-Host "üì¶ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $($size.ToString('0.00')) MB"
          } else {
            Write-Error "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –¥–ª—è Windows 7 x64"
            exit 1
          }

      - name: Upload Windows 7 x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgiAnalytics-Win7-x64
          path: dist/AgiAnalytics_Win7_x64.exe

  build-win10-x86:
    name: Build Windows 10 (x86)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.9.13 (x86)
        uses: actions/setup-python@v5
        with:
          python-version: '3.9.13'
          architecture: x86

      - name: Install dependencies for Windows 10 (x86)
        run: |
          python -m pip install --upgrade pip
          pip install numpy==1.24.3
          pip install pandas==1.5.3
          pip install PyQt5==5.15.9
          pip install pyinstaller==5.12.0
          pip install openpyxl==3.1.2
          pip install pillow==9.5.0

      - name: Build executable for Windows 10 (x86)
        run: |
          $exe_name = "AgiAnalytics_Win10_x86"
          Remove-Item -Recurse -Force dist, build -ErrorAction SilentlyContinue
          
          pyinstaller --onefile --windowed --name="$exe_name" --clean --hidden-import=PyQt5 --hidden-import=PyQt5.QtCore --hidden-import=PyQt5.QtGui --hidden-import=PyQt5.QtWidgets --hidden-import=pandas --hidden-import=numpy --hidden-import=numpy.core._multiarray_umath --hidden-import=openpyxl --hidden-import=sqlite3 main.py
          
          if (Test-Path "dist/$exe_name.exe") {
            Write-Host "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞ –¥–ª—è Windows 10 x86"
            $size = (Get-Item "dist/$exe_name.exe").Length / 1MB
            Write-Host "üì¶ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $($size.ToString('0.00')) MB"
          } else {
            Write-Error "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –¥–ª—è Windows 10 x86"
            exit 1
          }

      - name: Upload Windows 10 x86 artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgiAnalytics-Win10-x86
          path: dist/AgiAnalytics_Win10_x86.exe

  build-win10-x64:
    name: Build Windows 10 (x64)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.9.13 (x64)
        uses: actions/setup-python@v5
        with:
          python-version: '3.9.13'
          architecture: x64

      - name: Install dependencies for Windows 10 (x64)
        run: |
          python -m pip install --upgrade pip
          pip install numpy==1.24.3
          pip install pandas==1.5.3
          pip install PyQt5==5.15.9
          pip install pyinstaller==5.12.0
          pip install openpyxl==3.1.2
          pip install pillow==9.5.0

      - name: Build executable for Windows 10 (x64)
        run: |
          $exe_name = "AgiAnalytics_Win10_x64"
          Remove-Item -Recurse -Force dist, build -ErrorAction SilentlyContinue
          
          pyinstaller --onefile --windowed --name="$exe_name" --clean --hidden-import=PyQt5 --hidden-import=PyQt5.QtCore --hidden-import=PyQt5.QtGui --hidden-import=PyQt5.QtWidgets --hidden-import=pandas --hidden-import=numpy --hidden-import=numpy.core._multiarray_umath --hidden-import=openpyxl --hidden-import=sqlite3 main.py
          
          if (Test-Path "dist/$exe_name.exe") {
            Write-Host "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞ –¥–ª—è Windows 10 x64"
            $size = (Get-Item "dist/$exe_name.exe").Length / 1MB
            Write-Host "üì¶ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $($size.ToString('0.00')) MB"
          } else {
            Write-Error "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –¥–ª—è Windows 10 x64"
            exit 1
          }

      - name: Upload Windows 10 x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgiAnalytics-Win10-x64
          path: dist/AgiAnalytics_Win10_x64.exe

  create-release:
    name: Create Release Package
    needs: [build-win7-x86, build-win7-x64, build-win10-x86, build-win10-x64]
    runs-on: windows-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release structure
        run: |
          New-Item -ItemType Directory -Force -Path "AgiAnalytics_v$env:GITHUB_RUN_NUMBER"
          
          $folders = @("Windows_7_32bit", "Windows_7_64bit", "Windows_10_32bit", "Windows_10_64bit")
          foreach ($folder in $folders) {
            New-Item -ItemType Directory -Force -Path "AgiAnalytics_v$env:GITHUB_RUN_NUMBER\$folder"
          }
          
          if (Test-Path "artifacts/AgiAnalytics-Win7-x86/AgiAnalytics_Win7_x86.exe") {
            Copy-Item "artifacts/AgiAnalytics-Win7-x86/AgiAnalytics_Win7_x86.exe" "AgiAnalytics_v$env:GITHUB_RUN_NUMBER\Windows_7_32bit\"
          }
          
          if (Test-Path "artifacts/AgiAnalytics-Win7-x64/AgiAnalytics_Win7_x64.exe") {
            Copy-Item "artifacts/AgiAnalytics-Win7-x64/AgiAnalytics_Win7_x64.exe" "AgiAnalytics_v$env:GITHUB_RUN_NUMBER\Windows_7_64bit\"
          }
          
          if (Test-Path "artifacts/AgiAnalytics-Win10-x86/AgiAnalytics_Win10_x86.exe") {
            Copy-Item "artifacts/AgiAnalytics-Win10-x86/AgiAnalytics_Win10_x86.exe" "AgiAnalytics_v$env:GITHUB_RUN_NUMBER\Windows_10_32bit\"
          }
          
          if (Test-Path "artifacts/AgiAnalytics-Win10-x64/AgiAnalytics_Win10_x64.exe") {
            Copy-Item "artifacts/AgiAnalytics-Win10-x64/AgiAnalytics_Win10_x64.exe" "AgiAnalytics_v$env:GITHUB_RUN_NUMBER\Windows_10_64bit\"
          }
          
          $launcherContent = @'
          @echo off
          chcp 65001 >nul
          echo ========================================
          echo   AgiAnalytics - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫
          echo ========================================
          echo.
          echo –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã...
          
          set OS=
          set ARCH=
          
          ver | findstr /i "6\.1" >nul && set OS=7
          ver | findstr /i "10\." >nul && set OS=10
          
          if "%PROCESSOR_ARCHITECTURE%"=="AMD64" (
              set ARCH=x64
          ) else (
              set ARCH=x86
          )
          
          echo.
          echo –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: Windows %OS% (%ARCH%)
          echo.
          
          if "%OS%"=="7" (
              echo ‚ö†Ô∏è  –í–ê–ñ–ù–û: –î–ª—è Windows 7 —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
              echo    1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ VC++ Redistributable
              echo    2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ KB2999226
              echo.
              pause
          )
          
          if exist "Windows_%OS%_%ARCH%\AgiAnalytics_Win%OS%_%ARCH%.exe" (
              echo –ó–∞–ø—É—Å–∫ AgiAnalytics_Win%OS%_%ARCH%.exe...
              start "" "Windows_%OS%_%ARCH%\AgiAnalytics_Win%OS%_%ARCH%.exe"
          ) else (
              echo ‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
              pause
          )
          '@
          
          Set-Content -Path "AgiAnalytics_v$env:GITHUB_RUN_NUMBER\Start_AgiAnalytics.bat" -Value $launcherContent -Encoding UTF8
          
          $readmeContent = @'
          ========================================
          AgiAnalytics v${{ github.run_number }}
          ========================================
          
          –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
          1. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤
          2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Start_AgiAnalytics.bat
          3. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≤–∞—à—É —Å–∏—Å—Ç–µ–º—É
          
          –í–ê–ñ–ù–û –î–õ–Ø WINDOWS 7:
          1. Visual C++ Redistributable 2015-2022
          2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ KB2999226
          3. –í—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Windows
          
          –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–û–ö:
          1. –û—à–∏–±–∫–∞ api-ms-win-core-path-l1-1-0.dll - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ KB2999226
          2. –û—à–∏–±–∫–∞ VCRUNTIME140.dll - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ VC++ Redistributable
          3. –ê–Ω—Ç–∏–≤–∏—Ä—É—Å –±–ª–æ–∫–∏—Ä—É–µ—Ç - –¥–æ–±–∞–≤—å—Ç–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
          
          –ü–û–î–î–ï–†–ñ–ö–ê:
          GitHub Issues: https://github.com/${{ github.repository }}/issues
          '@
          
          Set-Content -Path "AgiAnalytics_v$env:GITHUB_RUN_NUMBER\README.txt" -Value $readmeContent -Encoding UTF8

      - name: Create ZIP archive
        run: |
          Compress-Archive -Path "AgiAnalytics_v$env:GITHUB_RUN_NUMBER\*" -DestinationPath "AgiAnalytics_v$env:GITHUB_RUN_NUMBER.zip"
          Write-Host "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω"

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgiAnalytics-Release
          path: AgiAnalytics_v${{ github.run_number }}.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: AgiAnalytics_v${{ github.run_number }}.zip
          tag_name: v${{ github.run_number }}
          name: AgiAnalytics v${{ github.run_number }}
          body: |
            # üöÄ AgiAnalytics v${{ github.run_number }}
            
            ## üì¶ –°–û–î–ï–†–ñ–ò–ú–û–ï –ê–†–•–ò–í–ê:
            
            - `Windows_7_32bit/` - Windows 7 32-bit
            - `Windows_7_64bit/` - Windows 7 64-bit  
            - `Windows_10_32bit/` - Windows 10 32-bit
            - `Windows_10_64bit/` - Windows 10 64-bit
            - `Start_AgiAnalytics.bat` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫
            - `README.txt` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
            
            ## ‚ö†Ô∏è –î–õ–Ø WINDOWS 7:
            
            1. [VC++ Redistributable x86](https://aka.ms/vs/17/release/vc_redist.x86.exe)
            2. [VC++ Redistributable x64](https://aka.ms/vs/17/release/vc_redist.x64.exe)
            3. [KB2999226 x86](https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/updt/2015/07/windows6.1-kb2999226-x86.msu)
            4. [KB2999226 x64](https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/updt/2015/07/windows6.1-kb2999226-x64.msu)
            
            ## üìä –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò:
            
            | –°–∏—Å—Ç–µ–º–∞ | Python | –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | PyInstaller |
            |---------|--------|-------------|-------------|
            | Windows 7 | 3.8.10 | x86/x64 | 5.0.1 |
            | Windows 10 | 3.9.13 | x86/x64 | 5.12.0 |
            
            [–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ](https://github.com/${{ github.repository }}/issues/new)