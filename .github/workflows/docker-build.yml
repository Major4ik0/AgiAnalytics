name: Build Windows Executable

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        architecture: 'x64'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Create icon if not exists
      run: |
        if (!(Test-Path "icon.ico")) {
          # Создаем простую иконку используя PowerShell
          $bitmap = New-Object System.Drawing.Bitmap(64, 64)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.Clear([System.Drawing.Color]::FromArgb(0, 120, 215))
          $font = New-Object System.Drawing.Font("Arial", 24, [System.Drawing.FontStyle]::Bold)
          $brush = [System.Drawing.Brushes]::White
          $graphics.DrawString("AG", $font, $brush, 10, 15)
          $graphics.Dispose()
          
          # Сохраняем как иконку
          $stream = New-Object System.IO.MemoryStream
          $icon = [System.Drawing.Icon]::FromHandle($bitmap.GetHicon())
          $icon.Save($stream)
          [System.IO.File]::WriteAllBytes("icon.ico", $stream.ToArray())
          $stream.Dispose()
          $icon.Dispose()
          $bitmap.Dispose()
        }
    
    - name: Build with PyInstaller
      run: |
        # Создаем временный spec файл
        $specContent = @"
# -*- mode: python ; coding: utf-8 -*-
a = Analysis(
    ['main.py'],
    pathex=[],
    binaries=[],
    datas=[
        ('app.ui', '.'),
        ('icon.ico', '.'),
    ],
    hiddenimports=[
        'PyQt6',
        'PyQt6.QtCore',
        'PyQt6.QtGui',
        'PyQt6.QtWidgets',
        'PyQt6.QtPrintSupport',
        'pandas',
        'numpy',
        'openpyxl',
        'sqlite3',
        'matplotlib.backends.backend_qtagg',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=None,
    noarchive=False,
)
pyz = PYZ(a.pure, a.zipped_data, cipher=None)
exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.datas,
    [],
    name='AgiAnalytics',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    runtime_tmpdir=None,
    console=False,
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    icon='icon.ico'
)
"@
        
        $specContent | Out-File -FilePath "agianalytics.spec" -Encoding UTF8
        
        # Запускаем сборку
        pyinstaller agianalytics.spec
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: AgiAnalytics-Windows
        path: dist/AgiAnalytics.exe
