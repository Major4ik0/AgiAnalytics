name: Package Release

on:
  workflow_run:
    workflows:
      - "Build Windows 7 (x86)"
      - "Build Windows 7 (x64)"
      - "Build Windows 10 (x86)"
      - "Build Windows 10 (x64)"
    types:
      - completed

  workflow_dispatch:

jobs:
  package:
    runs-on: windows-latest

    steps:
      - name: Download all artifacts
        run: |
          # Создаем папку для артефактов
          New-Item -ItemType Directory -Force -Path "artifacts"
          
          # Скачиваем все артефакты
          $artifacts = @(
            "AgiAnalytics-Win7-x86",
            "AgiAnalytics-Win7-x64",
            "AgiAnalytics-Win10-x86",
            "AgiAnalytics-Win10-x64"
          )
          
          foreach ($artifact in $artifacts) {
            Write-Host "Downloading $artifact..."
            gh run download --artifact="$artifact" --dir="artifacts/$artifact"
          }

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release package
        run: |
          $version = "${{ github.run_number }}"
          $release_dir = "AgiAnalytics_v$version"
          
          New-Item -ItemType Directory -Force -Path $release_dir
          
          # Создаем структуру папок
          $folders = @(
            "Windows_7_32bit",
            "Windows_7_64bit",
            "Windows_10_32bit",
            "Windows_10_64bit"
          )
          
          foreach ($folder in $folders) {
            New-Item -ItemType Directory -Force -Path "$release_dir\$folder"
          }
          
          # Копируем файлы
          if (Test-Path "artifacts/AgiAnalytics-Win7-x86/AgiAnalytics_Win7_x86.exe") {
            Copy-Item "artifacts/AgiAnalytics-Win7-x86/AgiAnalytics_Win7_x86.exe" "$release_dir\Windows_7_32bit\"
            if (Test-Path "artifacts/AgiAnalytics-Win7-x86/Run_Win7_x86.bat") {
              Copy-Item "artifacts/AgiAnalytics-Win7-x86/Run_Win7_x86.bat" "$release_dir\Windows_7_32bit\"
            }
          }
          
          if (Test-Path "artifacts/AgiAnalytics-Win7-x64/AgiAnalytics_Win7_x64.exe") {
            Copy-Item "artifacts/AgiAnalytics-Win7-x64/AgiAnalytics_Win7_x64.exe" "$release_dir\Windows_7_64bit\"
            if (Test-Path "artifacts/AgiAnalytics-Win7-x64/Run_Win7_x64.bat") {
              Copy-Item "artifacts/AgiAnalytics-Win7-x64/Run_Win7_x64.bat" "$release_dir\Windows_7_64bit\"
            }
          }
          
          if (Test-Path "artifacts/AgiAnalytics-Win10-x86/AgiAnalytics_Win10_x86.exe") {
            Copy-Item "artifacts/AgiAnalytics-Win10-x86/AgiAnalytics_Win10_x86.exe" "$release_dir\Windows_10_32bit\"
          }
          
          if (Test-Path "artifacts/AgiAnalytics-Win10-x64/AgiAnalytics_Win10_x64.exe") {
            Copy-Item "artifacts/AgiAnalytics-Win10-x64/AgiAnalytics_Win10_x64.exe" "$release_dir\Windows_10_64bit\"
          }
          
          # Создаем README
          $readme_content = @'
          ========================================
          AgiAnalytics - Приложение для абитуриентов
          ========================================
          
          Версия: $version
          
          ИНСТРУКЦИЯ:
          -----------
          1. Выберите папку для вашей версии Windows
          2. Для Windows 7: запустите Run_Win7_*.bat файл
          3. Для Windows 10: запустите .exe файл
          
          ВАЖНО ДЛЯ WINDOWS 7:
          --------------------
          Перед запуском установите:
          1. Visual C++ Redistributable 2015-2022
          2. Обновление KB2999226
          3. Все обновления Windows
          
          Ссылки:
          - VC++ Redist: https://aka.ms/vs/17/release/vc_redist.x86.exe (32-bit)
          - VC++ Redist: https://aka.ms/vs/17/release/vc_redist.x64.exe (64-bit)
          - KB2999226: https://support.microsoft.com/ru-ru/topic/обновление-для-универсальной-среды-выполнения-c-в-windows-c0514201-7fe6-95a3-b0a5-287930f3560c
          
          ПОДДЕРЖКА:
          ----------
          GitHub Issues: https://github.com/${{ github.repository }}/issues
          '@
          
          Set-Content -Path "$release_dir\README.txt" -Value $readme_content -Encoding UTF8
          
          # Создаем BAT файл для установки
          $install_bat = @'
          @echo off
          echo ========================================
          echo AgiAnalytics - Установка
          echo ========================================
          echo.
          echo Выберите вашу версию Windows:
          echo.
          echo 1. Windows 7 (32-bit)
          echo 2. Windows 7 (64-bit)
          echo 3. Windows 10 (32-bit)
          echo 4. Windows 10 (64-bit)
          echo.
          set /p choice="Введите номер: "
          
          if "%choice%"=="1" (
              echo Открываю папку для Windows 7 32-bit...
              start "" "Windows_7_32bit"
          ) else if "%choice%"=="2" (
              echo Открываю папку для Windows 7 64-bit...
              start "" "Windows_7_64bit"
          ) else if "%choice%"=="3" (
              echo Открываю папку для Windows 10 32-bit...
              start "" "Windows_10_32bit"
          ) else if "%choice%"=="4" (
              echo Открываю папку для Windows 10 64-bit...
              start "" "Windows_10_64bit"
          ) else (
              echo Неверный выбор
              pause
          )
          '@
          
          Set-Content -Path "$release_dir\Install.bat" -Value $install_bat -Encoding ASCII
          
          # Архивируем
          Compress-Archive -Path "$release_dir\*" -DestinationPath "AgiAnalytics_v$version.zip" -Force
          
          Write-Host "Release package created: AgiAnalytics_v$version.zip"

      - name: Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: AgiAnalytics-Release
          path: AgiAnalytics_v${{ github.run_number }}.zip

      - name: Create GitHub Release
        if: github.event.workflow_run.conclusion == 'success'
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: AgiAnalytics_v${{ github.run_number }}.zip
          tag_name: v${{ github.run_number }}
          name: AgiAnalytics v${{ github.run_number }}
          body: |
            # AgiAnalytics v${{ github.run_number }}
            
            Сборки для всех версий Windows:
            
            - Windows 7 (32-bit) - с исправлениями DLL
            - Windows 7 (64-bit) - с исправлениями DLL  
            - Windows 10 (32-bit)
            - Windows 10 (64-bit)
            
            Для Windows 7 используйте файлы Run_Win7_*.bat